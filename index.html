<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ†å¸³è¨˜å¸³ç°¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* ä¿®æ­£ï¼šç§»é™¤è¼¸å…¥æ¡†åŸç”Ÿçš„å¢æ¸›æ§åˆ¶é … */
        input[type='number'] {
            -moz-appearance: textfield;
        }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* âœ¨ NEW: ä¿®æ­£ Modal é–ƒçˆå•é¡Œï¼Œé‡å° Safari/WebKit å„ªåŒ– */
        .force-gpu {
            /* è®“ç€è¦½å™¨æ¨åˆ°ç¨ç«‹åœ–å±¤ï¼Œè§£æ±ºèƒŒæ™¯é–ƒçˆ */
            transform: translateZ(0);
            /* å‘Šè¨´ç€è¦½å™¨æº–å‚™è®ŠåŒ–ï¼Œé¿å…é‡æ–°è¨ˆç®— */
            will-change: transform; 
        }
    </style>
    
    <script>
        // è¨­å®š Tailwind CSS é¡è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primaryColor: {
                            500: '#14b8a6', // teal-500
                            600: '#0d9488', // teal-600
                            700: '#0f766e', // teal-700
                        },
                    },
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script>
        // ä¿®æ­£ï¼šå°‡é€™äº›è®Šæ•¸å®šç¾©åœ¨ç´” JS å€å¡Šï¼Œä½¿ Babel è…³æœ¬å¯ä»¥è¨ªå•
        const __app_id = "YOUR_APP_ID"; // ä¾‹å¦‚: 'my-splitwise-app-2025'
        // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé…ç½® JSON
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyANDhJ--MDYI5SfsHOuuQwVM0sYMM91UFM",
            authDomain: "splite-expense-tracker-multi.firebaseapp.com",
            projectId: "splite-expense-tracker-multi",
            storageBucket: "splite-expense-tracker-multi.firebasestorage.app",
            messagingSenderId: "10696910340",
            appId: "1:10696910340:web:2ccda0f7db8ef8af6f3751",
            measurementId: "G-XCB90NSB43"
        });
        // åŒ¿åç™»å…¥ä¸å†ä½¿ç”¨ï¼Œæ•…ä¸éœ€è¦ __initial_auth_token

        // æ–°å¢ï¼šè«‹å°‡æ‚¨çš„ Gemini API Key å¡«å…¥æ­¤è™•ï¼ˆç›®å‰æœªä½¿ç”¨ï¼‰
        const GEMINI_API_KEY = ""; 
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    
    <script type="text/babel">
        // æ˜ç¢ºè²æ˜ React ç‚ºå…¨åŸŸè®Šæ•¸ï¼Œç¢ºä¿ Babel èƒ½å¤ æ‰¾åˆ°å®ƒ
        const React = window.React;
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // å°‡å…¨åŸŸè®Šæ•¸å¼•å…¥ Babel ä½œç”¨åŸŸ
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        // æ³¨æ„ï¼šGEMINI_API_KEY å·²åœ¨é ‚å±¤çš„ç´” JS å€å¡Šä¸­å®šç¾©ï¼Œå¯ä»¥ç›´æ¥è¨ªå•
        const { firestore } = firebase;
        const serverTimestamp = firestore.FieldValue.serverTimestamp; 
        
		const getGroupExpensesPath = (groupId) =>
		  `artifacts/${appId}/groups/${groupId}/expenses`;

		const getGroupMembersDocPath = (groupId) =>
		  `artifacts/${appId}/groups/${groupId}/settings/members`;
		
        // --- åŒ¯ç‡è¨­å®š (é è¨­å€¼ä½œç‚ºå‚™ç”¨) ---
        const PERMANENT_RATES_CACHE_KEY = "permanentExchangeRates";

        const HARDCODED_DEFAULT_RATES = {
            'TWD': 1.0,   // åŸºæº–è²¨å¹£ï¼šè‡ºå¹£
            'USD': 30.5,  // ç¾é‡‘
            'THB': 0.85,  // æ³°éŠ–
            'EUR': 33.0,  // æ­å…ƒ
            'CAD': 22.5,  // åŠ å¹£
            'VND': 0.0013, // è¶Šå—ç›¾ (1000 VND ~ 1.3 TWD)
            'IDR': 0.002, // å°å°¼ç›¾ (1000 IDR ~ 2 TWD)
            'JPY': 0.25,  // æ—¥åœ“
            'KRW': 0.023, // éŸ“å…ƒ (1000 KRW ~ 23 TWD)
            'AUD': 20.0,  // æ¾³å¹£
            'NOK': 2.9,   // æŒªå¨å…‹æœ—
        };

        // âœ¨ MODIFIED: å˜—è©¦å¾æŒä¹…åŒ–å¿«å–è®€å–é è¨­å€¼
        let DEFAULT_EXCHANGE_RATES = (function() {
            try {
                const cachedRates = localStorage.getItem(PERMANENT_RATES_CACHE_KEY);
                if (cachedRates) {
                    return JSON.parse(cachedRates);
                }
            } catch (e) {
                console.warn("âš  è®€å–æŒä¹…åŒ–åŒ¯ç‡å¿«å–å¤±æ•—ï¼Œä½¿ç”¨ç¡¬ç·¨ç¢¼é è¨­å€¼ã€‚", e);
            }
            return HARDCODED_DEFAULT_RATES;
        })();
		
		// --- åœ‹å®¶ -> è²¨å¹£ å°ç…§è¡¨ï¼ˆçµ¦ GPS ç”¨ï¼‰ ---
		const COUNTRY_CURRENCY_MAP = {
			TW: 'TWD',
			US: 'USD',
			CA: 'CAD',
			AU: 'AUD',
			JP: 'JPY',
			KR: 'KRW',
			TH: 'THB',
			VN: 'VND',
			ID: 'IDR',
			NO: 'NOK',
			// æ­æ´²å¸¸è¦‹åœ‹å®¶ -> æ­å…ƒ
			FR: 'EUR',
			DE: 'EUR',
			ES: 'EUR',
			IT: 'EUR',
			NL: 'EUR',
			BE: 'EUR',
			PT: 'EUR',
		};
		
        const CURRENCIES = Object.keys(HARDCODED_DEFAULT_RATES); // å¹£åˆ¥åˆ—è¡¨ä»ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„ Key
        const DEFAULT_CURRENCY = 'TWD';

        // --- åŒ¯ç‡ç²å–å‡½å¼ï¼šæ¯ 4 å°æ™‚æ›´æ–°ä¸€æ¬¡ + å¯é¡¯ç¤ºæ›´æ–°æ™‚é–“ ---
		const fetchExchangeRates = async () => {
			const CACHE_KEY = "exchangeRatesCache";
			const CACHE_TIME_KEY = "exchangeRatesCacheTime";
			const FOUR_HOURS = 4 * 60 * 60 * 1000;

			// 1. å¾ localStorage è®€å–è‡¨æ™‚å¿«å–
			try {
				const cachedRates = localStorage.getItem(CACHE_KEY);
				const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

				if (cachedRates && cachedTime) {
					const lastUpdate = parseInt(cachedTime, 10);
					const now = Date.now();

					// å°‘æ–¼ 4 å°æ™‚ â†’ ä½¿ç”¨è‡¨æ™‚å¿«å–
					if (now - lastUpdate < FOUR_HOURS) {
						console.log("ğŸ“¦ ä½¿ç”¨è‡¨æ™‚å¿«å–åŒ¯ç‡ï¼ˆ4 å°æ™‚å…§ï¼‰");

						return {
							rates: JSON.parse(cachedRates),
							lastUpdate
						};
					}
				}
			} catch (err) {
				console.warn("âš  è®€å–è‡¨æ™‚åŒ¯ç‡å¿«å–å¤±æ•—ï¼Œå°‡é‡æ–°æŠ“å–ã€‚", err);
			}

			// 2. è¶…é 4 å°æ™‚ â†’ æŠ“å–æ–°è³‡æ–™
			const API_URL = "https://open.er-api.com/v6/latest/TWD";

			try {
				const res = await fetch(API_URL);
				if (!res.ok) throw new Error("API å›æ‡‰éŒ¯èª¤");

				const data = await res.json();
				if (!data || data.result !== "success") throw new Error("ç„¡æ•ˆåŒ¯ç‡è³‡æ–™");

				const processedRates = { [DEFAULT_CURRENCY]: 1.0 };

				CURRENCIES.forEach(code => {
					if (code === DEFAULT_CURRENCY) return;

					const rateTWDToCode = data.rates[code]; // 1 TWD = x {code}
					if (typeof rateTWDToCode === "number" && rateTWDToCode > 0) {
						processedRates[code] = 1 / rateTWDToCode; // 1 {code} = ? TWD
					} else {
                        // å¦‚æœ API æ²’çµ¦ï¼Œä½¿ç”¨ç¡¬ç·¨ç¢¼é è¨­å€¼
						processedRates[code] = HARDCODED_DEFAULT_RATES[code];
					}
				});

				const now = Date.now();

				// 3. å¯«å…¥ Cache
				try {
					localStorage.setItem(CACHE_KEY, JSON.stringify(processedRates));
					localStorage.setItem(CACHE_TIME_KEY, now.toString());
                    // âœ¨ NEW: å¯«å…¥æ°¸ä¹…å‚™ç”¨å¿«å–
                    localStorage.setItem(PERMANENT_RATES_CACHE_KEY, JSON.stringify(processedRates));
                    // æ›´æ–°å…¨åŸŸ DEFAULT_EXCHANGE_RATES è®Šæ•¸
                    DEFAULT_EXCHANGE_RATES = processedRates;
				} catch (err) {
					console.warn("âš ï¸ ç„¡æ³•å¯«å…¥å¿«å–ï¼ˆå¯èƒ½æ˜¯ç„¡ç—•æ¨¡å¼ï¼‰", err);
				}

				console.log("ğŸŒ å·²æŠ“å–æœ€æ–°åŒ¯ç‡", processedRates);

				return {
					rates: processedRates,
					lastUpdate: now
				};

			} catch (err) {
				console.error("âŒ æŠ“å–åŒ¯ç‡å¤±æ•—ï¼Œä½¿ç”¨é è¨­åŒ¯ç‡", err);
				const fallbackTime = Date.now();

				return {
					// ä½¿ç”¨æŒä¹…åŒ–æˆ–ç¡¬ç·¨ç¢¼çš„ DEFAULT_EXCHANGE_RATES
					rates: DEFAULT_EXCHANGE_RATES, 
					lastUpdate: fallbackTime
				};
			}
		};

        // --- åˆ†äº«é€£çµç”¨çš„çŸ­ä»£ç¢¼ç”¢ç”Ÿå™¨ ---
        const generateShortCode = (length = 6) => {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // é¿å… O/0ã€I/1 ç­‰æ··æ·†
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };


        // --- å…§è¯ SVG åœ–æ¨™å…ƒä»¶ (Lucide æ¨£å¼) ---
        const IconProps = {
            stroke: "currentColor",
            strokeWidth: 2,
            strokeLinecap: "round",
            strokeLinejoin: "round",
            fill: "none",
        };
        
        const CircleDollarSign = (props) =>
		  <svg {...props} {...IconProps} viewBox="0 0 24 24">
			<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
			<polyline points="14 2 14 8 20 8"/>
			<line x1="16" x2="8" y1="13" y2="13"/>
			<line x1="16" x2="8" y1="17" y2="17"/>
			<line x1="10" x2="8" y1="9" y2="9"/>
		  </svg>;
        const Trash2 = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const Plus = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>;
        const Minus = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M5 12h14"></path></svg>;
        const Users = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;
        const X = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>;
        const CircleCheck = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14 9 11"></polyline></svg>;
        const Pencil = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>;
        const UserPlus = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" x2="19" y1="8" y2="14"></line><line x1="16" x2="22" y1="11" y2="11"></line></svg>;
        const UserMinus = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="22" x2="16" y1="11" y2="11"></line></svg>;
        const LogOut = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>;
        const RefreshCw = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.76 2.91L3 8"></path><path d="M3 3v5h5"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.76-2.91L21 16"></path><path d="M21 21v-5h-5"></path></svg>;
        const Share2 = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"></line><line x1="15.42" x2="8.59" y1="6.51" y2="10.49"></line></svg>;
        // âœ¨ NEW: æ”¾å¤§é¡åœ–æ¨™ (Search)
        const Search = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>;
        // --- åœ–æ¨™å…ƒä»¶çµæŸ ---

        /**
         * å‰µå»ºæˆ–æ›´æ–° Firestore å…¬å…± Profile
         */
        const createOrUpdatePublicProfile = async (db, uid, displayName, email) => {
            if (!db || !uid || !displayName) return;
            const profileDocPath = `artifacts/${appId}/public_profiles/${uid}`;
            try {
                await db.doc(profileDocPath).set({ 
                    displayName: displayName,
                    email: email,
                    uid: uid,
                }, { merge: true });
            } catch (e) {
                console.error("Error creating/updating public profile:", e);
            }
        };
        
        /**
         * é€šç”¨ç¢ºèªæç¤º Modal
         */
        const ConfirmationModal = React.memo(({ isOpen, onClose, onConfirm, title, message, confirmText, confirmColor = 'red' }) => {
            if (!isOpen) return null;

            const colorClass =
                confirmColor === 'green'
                    ? 'bg-green-600 hover:bg-green-700'
                    : 'bg-red-600 hover:bg-red-700';

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[9999] transition-opacity force-gpu">
                    <div className="bg-white rounded-xl w-full max-w-sm shadow-2xl transform transition-transform duration-300 scale-100 force-gpu">
                        <div className="p-6">
                            <h3 className="text-xl font-bold text-gray-800 mb-4">{title}</h3>
                            <p className="text-gray-600 mb-6">{message}</p>
                            <div className="flex justify-end space-x-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 rounded-full text-gray-700 bg-gray-200 hover:bg-gray-300 transition font-semibold"
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    onClick={onConfirm}
                                    className={`px-4 py-2 rounded-full text-white font-semibold transition duration-150 shadow-md ${colorClass}`}
                                >
                                    {confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        });

        /**
         * èªè­‰æ¨¡æ…‹è¦–çª—
         */
        const AuthModal = React.memo(({ auth, db, setToastMessage }) => { 
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [nickname, setNickname] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);

                if (!email || !password || (!isLogin && !nickname)) {
                    setToastMessage('âŒ è«‹è¼¸å…¥æ‰€æœ‰å¿…å¡«æ¬„ä½ã€‚'); 
                    setIsLoading(false);
                    return;
                }

                try {
                    let userCredential;
                    let finalDisplayName = nickname.trim();

                    if (isLogin) {
                        userCredential = await auth.signInWithEmailAndPassword(email, password);
                        finalDisplayName = userCredential.user.displayName || email;
                    } else {
                        userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        await userCredential.user.updateProfile({
                            displayName: finalDisplayName
                        });
                    }
                    
                    if (db) {
                        await createOrUpdatePublicProfile(db, userCredential.user.uid, finalDisplayName, email);
                    }
                    
                    setToastMessage(`âœ… ç™»å…¥æˆåŠŸï¼æ­¡è¿ ${finalDisplayName}ã€‚`);

                } catch (e) {
                    console.error("Auth error:", e.code, e.message);
                    let displayError = e.message;
                    if (e.code === 'auth/email-already-in-use') {
                        displayError = 'è©²é›»å­éƒµä»¶å·²è¢«è¨»å†Šï¼Œè«‹ç›´æ¥ç™»å…¥æˆ–ä½¿ç”¨ä¸åŒéƒµä»¶ã€‚';
                    } else if (e.code === 'auth/invalid-email') {
                        displayError = 'ç„¡æ•ˆçš„é›»å­éƒµä»¶æ ¼å¼ã€‚';
                    } else if (e.code === 'auth/wrong-password' || e.code === 'auth/user-not-found') {
                        displayError = 'é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚';
                    } else if (e.code === 'auth/weak-password') {
                        displayError = 'å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹ä½¿ç”¨è‡³å°‘ 6 å€‹å­—å…ƒã€‚';
                    }
                    setToastMessage(`âŒ ç™»å…¥/è¨»å†Šå¤±æ•—: ${displayError}`); 

                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center p-4 z-50 force-gpu">
                    <div className="bg-white rounded-xl w-full max-w-md shadow-2xl p-6 sm:p-8 force-gpu">
                        <h3 className="text-3xl font-bold text-primaryColor-600 text-center mb-6">
                            {isLogin ? 'ç™»å…¥ç´€éŒ„ç°¿' : 'è¨»å†Šæ–°å¸³è™Ÿ'}
                        </h3>
                        {/* ç§»é™¤åŸæœ¬çš„éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºå€å¡Š */}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLogin && (
                                <div>
                                    <label htmlFor="nickname" className="block text-sm font-medium text-gray-700">æš±ç¨± (é¡¯ç¤ºåç¨±)</label>
                                    <input
                                        type="text"
                                        id="nickname"
                                        value={nickname}
                                        onChange={(e) => setNickname(e.target.value)}
                                        placeholder="è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±"
                                        className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                                        disabled={isLoading}
                                        required={!isLogin}
                                    />
                                </div>
                            )}

                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶</label>
                                <input
                                    type="email"
                                    id="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder="your.email@example.com"
                                    className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                                    disabled={isLoading}
                                />
                            </div>
                            <div>
                                <label htmlFor="password" className="block text-sm font-medium text-gray-700">å¯†ç¢¼ (è‡³å°‘ 6 ä½)</label>
                                <input
                                    type="password"
                                    id="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="******"
                                    className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                                    disabled={isLoading}
                                    minLength="6"
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={isLoading}
                                className={
                                    "w-full flex items-center justify-center px-4 py-3 rounded-full text-white font-semibold transition duration-300 shadow-lg " +
                                    (isLoading ? "bg-gray-400 cursor-not-allowed" : "bg-primaryColor-600 hover:bg-primaryColor-700")
                                }
                            >
                                {isLoading ? 'è™•ç†ä¸­...' : (isLogin ? 'ç™»å…¥' : 'è¨»å†Š')}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <button
                                onClick={() => { setIsLogin(prev => !prev); setToastMessage(null); setNickname(''); }}
                                className="text-primaryColor-600 hover:text-primaryColor-800 font-medium text-sm"
                            >
                                {isLogin ? 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š' : 'å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿé»æ­¤ç™»å…¥'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        });
        
		/**
         * æ”¯å‡º Modal (æ ¸å¿ƒé‚è¼¯ç¨ç«‹)
         */
        const ExpenseModal = React.memo(({ db, currentUserId, members, getInitialShares, state, onClose, getDisplayName, isReadOnly, collectionId, liveExchangeRates, defaultCurrency, currentUserLabel}) => {
            const [newExpense, setNewExpense] = useState({
                description: '',
                originalAmount: '',
                currency: defaultCurrency || DEFAULT_CURRENCY,
                payerName: currentUserId || '',
                shares: {}, 
            });
            const [isLoadingModal, setIsLoadingModal] = useState(false);
            const [modalError, setModalError] = useState(null);

            const isEditing = state.isEditing;
            const expenseToEdit = state.editingExpense;
            const modalTitle = isEditing ? 'ç·¨è¼¯æ”¯å‡ºè¨˜éŒ„' : 'æ–°å¢æ”¯å‡ºè¨˜éŒ„';
            const submitText = isEditing ? 'å„²å­˜ä¿®æ”¹' : 'ç¢ºèªæ–°å¢æ”¯å‡º';
            
            const currentExchangeRate = liveExchangeRates[newExpense.currency] || DEFAULT_EXCHANGE_RATES[newExpense.currency] || 1.0;
            const amountInTWD = useMemo(() => {
                const amount = parseFloat(newExpense.originalAmount) || 0;
                return Math.round(amount * currentExchangeRate);
            }, [newExpense.originalAmount, currentExchangeRate]);


            useEffect(() => {
                if (state.isOpen) {
                    if (isEditing && expenseToEdit) {
                        const initialShares = members.reduce((acc, name) => ({ 
                            ...acc, 
                            [name]: expenseToEdit.shares[name] !== undefined ? expenseToEdit.shares[name] : 0 
                        }), {});
                        setNewExpense({
                            description: expenseToEdit.description,
                            originalAmount: expenseToEdit.originalAmount,
                            currency: expenseToEdit.currency || DEFAULT_CURRENCY,
                            payerName: expenseToEdit.payerName,
                            shares: initialShares,
                        });
					} else {
					  // æ±ºå®šé è¨­çš„ä»˜æ¬¾äººï¼š
					  // 1. å¦‚æœ members è£¡åŒ…å« currentUserIdï¼Œå„ªå…ˆç”¨ currentUserId
					  // 2. å¦å‰‡ï¼Œå¦‚æœæœ‰æˆå“¡é¡¯ç¤ºåç¨± == currentUserLabelï¼Œå°±ç”¨é‚£å€‹æˆå“¡
					  // 3. éƒ½æ²’æœ‰å°± fallback å›åŸæœ¬çš„é‚è¼¯
					  let defaultPayerId = null;

					  if (currentUserId && members.includes(currentUserId)) {
						defaultPayerId = currentUserId;
					  }

					  if (!defaultPayerId && currentUserLabel) {
						for (const memberId of members) {
						  try {
							const label = getDisplayName(memberId);
							if (label === currentUserLabel) {
							  defaultPayerId = memberId;
							  break;
							}
						  } catch (e) {
							// getDisplayName å‡ºéŒ¯å°±å¿½ç•¥
						  }
						}
					  }

					  if (!defaultPayerId) {
						defaultPayerId = currentUserId || members[0] || '';
					  }

					  setNewExpense({
						description: '',
						originalAmount: '',
						currency: defaultCurrency || DEFAULT_CURRENCY,
						payerName: defaultPayerId,
						shares: getInitialShares(),
					  });
					}

                    setModalError(null);
                }
            }, [state.isOpen, isEditing, expenseToEdit, members, currentUserId, getInitialShares, currentUserLabel, getDisplayName, defaultCurrency]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setNewExpense(prev => ({
                    ...prev,
                    [name]: name === 'originalAmount' ? (value === '' ? '' : parseFloat(value) || '') : value,
                }));
            };

            const handleCurrencyChange = (e) => {
                 setNewExpense(prev => ({
                    ...prev,
                    currency: e.target.value,
                 }));
            };

            const handleShareChange = (name, delta) => {
                setNewExpense(prev => {
                    const currentShares = prev.shares[name] || 0;
                    const newShares = Math.max(0, currentShares + delta);
                    return {
                        ...prev,
                        shares: {
                            ...prev.shares,
                            [name]: newShares,
                        },
                    };
                });
            };

            const setToAverageSplit = () => {
                const averageShares = members.reduce((acc, name) => ({ ...acc, [name]: 1 }), {});
                setNewExpense(prev => ({
                    ...prev,
                    shares: averageShares,
                }));
            };

            const saveExpense = async () => {
                if (isReadOnly) {
                    setModalError('æ‚¨æ­£åœ¨ç€è¦½å…±äº«ç´€éŒ„ç°¿ï¼Œç„¡æ³•é€²è¡Œä¿®æ”¹ã€‚è«‹åˆ‡æ›å›æ‚¨çš„ç§æœ‰ç´€éŒ„ç°¿ã€‚');
                    return;
                }
                if (!db || !currentUserId) return;

                if (!newExpense.description.trim() || newExpense.originalAmount <= 0 || !newExpense.payerName) {
                    setModalError('è«‹è¼¸å…¥æœ‰æ•ˆçš„å“é …ã€é‡‘é¡å’Œä»˜æ¬¾äººï¼');
                    return;
                }

                setIsLoadingModal(true);
                setModalError(null);
                try {
                    const expenseToSave = {
                        description: newExpense.description,
                        originalAmount: newExpense.originalAmount,
                        currency: newExpense.currency,
                        exchangeRate: currentExchangeRate,
                        amountInTWD: amountInTWD,
                        payerName: newExpense.payerName,
                        shares: Object.entries(newExpense.shares).reduce((acc, [name, share]) => {
                            if (share > 0) acc[name] = share;
                            return acc;
                        }, {}),
                        ...(isEditing ? {} : { timestamp: serverTimestamp(), creatorId: currentUserId }),
                        appId: appId,
                    };

                    const collectionPath = getGroupExpensesPath(collectionId);
                    
                    if (isEditing) {
                        const docPath = `${collectionPath}/${expenseToEdit.id}`;
                        await db.doc(docPath).update(expenseToSave);
                    } else {
                        await db.collection(collectionPath).add(expenseToSave);
                    }

                    onClose();
                } catch (e) {
                    console.error("Error saving document: ", e);
                    setModalError(`å„²å­˜æ”¯å‡ºå¤±æ•—: ${e.message}`);
                } finally {
                    setIsLoadingModal(false);
                }
            };
            
            if (!state.isOpen) return null;

            return (
              // æ‡‰ç”¨ force-gpu åˆ°èƒŒæ™¯å±¤
              <div 
                key={isEditing && expenseToEdit ? expenseToEdit.id : 'add-new'} 
                className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-50 transition-opacity overflow-y-auto force-gpu"
              >
                {/* ä¿®æ­£ï¼šæ–°å¢ h-full å’Œ flex flex-col è®“å…§å®¹å¯ä»¥ç¨ç«‹æ»¾å‹• */}
                <div className="bg-white rounded-xl w-full max-w-lg shadow-2xl transform transition-transform duration-300 scale-100 my-4 h-full sm:h-auto sm:max-h-[95vh] flex flex-col force-gpu">
                  
                  {/* é ‚éƒ¨ï¼šå›ºå®šæ¨™é¡Œ (flex-shrink-0) */}
                  <div className="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h3 className="text-xl font-bold text-gray-800">
                        {modalTitle} {isReadOnly && <span className="text-red-500 ml-2">(å”¯è®€)</span>}
                    </h3>
                    <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-100 text-gray-600 transition hover:scale-110 transform">
                      <X className="w-6 h-6" />
                    </button>
                  </div>

                  {/* ä¸­é–“å…§å®¹ï¼šå¯æ»¾å‹• (flex-1 overflow-y-auto) */}
                  <div className="p-6 space-y-5 flex-1 overflow-y-auto">
                    {modalError && <p className="text-red-600 bg-red-100 p-3 rounded-lg text-sm">{modalError}</p>}
                    
                    {/* 1. å“é …èˆ‡é‡‘é¡ */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label htmlFor="description" className="block text-sm font-medium text-gray-700">å“é …/æè¿°</label>
                        <input
                          key="expense-description" 
                          type="text"
                          id="description"
                          name="description"
                          value={newExpense.description}
                          onChange={handleInputChange}
                          placeholder="ä¾‹å¦‚: æ™šé¤ï¼Œé›»å½±ç¥¨"
                          className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                          disabled={isReadOnly}
                        />
                      </div>
                      
                      {/* å¹£åˆ¥é¸æ“‡èˆ‡é‡‘é¡è¼¸å…¥ */}
                      <div>
                        <label htmlFor="originalAmount" className="block text-sm font-medium text-gray-700">å¹£å€¼/é‡‘é¡</label>
                        <div className="flex space-x-2 mt-1">
                          <select
                              id="currency"
                              name="currency"
                              value={newExpense.currency}
                              onChange={handleCurrencyChange}
                              className="block flex-shrink-0 w-auto border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500 bg-white disabled:bg-gray-100"
                              disabled={isReadOnly}
                          >
                            {CURRENCIES.map(code => (
                                <option key={code} value={code}>{code}</option>
                            ))}
                          </select>
                          <input
                            key="expense-amount" 
                            type="number"
                            id="originalAmount"
                            name="originalAmount"
                            value={newExpense.originalAmount}
                            onChange={handleInputChange}
                            placeholder="100.00"
                            className="block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                            disabled={isReadOnly}
                          />
                        </div>
                        
                        {/* é¡¯ç¤ºæ›ç®—å¾Œçš„å°å¹£é‡‘é¡ */}
                        {newExpense.originalAmount > 0 && newExpense.currency !== DEFAULT_CURRENCY && (
                           <p className="mt-1 text-xs text-gray-500 italic">
                               æ›ç®—å°å¹£ (TWD) ç´„: 
                               <span className="font-semibold text-primaryColor-600 ml-1">TWD {amountInTWD.toFixed(0)}</span>
                               (åŒ¯ç‡: {currentExchangeRate})
                           </p>
                        )}
                        {newExpense.originalAmount > 0 && newExpense.currency === DEFAULT_CURRENCY && (
                           <p className="mt-1 text-xs text-gray-500 italic">
                               åˆ†å¸³è¨ˆç®—ä½¿ç”¨æ­¤é‡‘é¡ (TWD)
                           </p>
                        )}
                      </div>
                    </div>

                    {/* 2. ä»˜æ¬¾äºº */}
                    <div>
                      <label htmlFor="payerName" className="block text-sm font-medium text-gray-700">ä»˜æ¬¾äºº</label>
                      <select
                        id="payerName"
                        name="payerName"
                        value={newExpense.payerName}
                        onChange={handleInputChange}
                        className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500 bg-white"
                        disabled={isReadOnly}
                      >
                        {members.map(member => (
                          <option key={member} value={member}>
                            {getDisplayName(member)}
                          </option>
                        ))}
                      </select>
                    </div>

                    {/* 3. åˆ†å¸³ä»½æ•¸è¨­å®š */}
                    <div className="pt-4 border-t border-gray-100">
                      <div className="flex justify-between items-center mb-3">
                        <label className="text-lg font-bold text-gray-700">åˆ†å¸³ä»½æ•¸</label>
                        <button
                          onClick={setToAverageSplit}
                          type="button"
                          className="text-sm text-primaryColor-600 hover:text-primaryColor-800 font-medium disabled:opacity-50"
                          disabled={isReadOnly}
                        >
                          [è¨­ç‚ºå¹³å‡åˆ†é…]
                        </button>
                      </div>
                      {/* ç§»é™¤ max-h-48ï¼Œè®“ flex-1 è² è²¬æ»¾å‹• */}
                      <div className="space-y-3 pr-2">
                        {members.map(member => {
                          const currentShares = newExpense.shares[member] || 0;
                          const displayMember = getDisplayName(member);
                          const isPayer = newExpense.payerName === member;

                          return (
                            <div key={member} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                              <span className={`font-medium ${isPayer ? 'text-primaryColor-700' : 'text-gray-700'}`}>
                                {displayMember} {isPayer && '(ä»˜æ¬¾äºº)'}
                              </span>
                              <div className="flex items-center space-x-2 flex-shrink-0">
                                <button
                                  onClick={() => handleShareChange(member, -1)}
                                  type="button"
                                  className="p-1.5 bg-red-50 text-red-600 rounded-lg transition hover:scale-105 transform hover:bg-red-100 shadow-sm border border-red-200 disabled:opacity-50 disabled:hover:scale-100"
                                  aria-label="æ¸›å°‘ä»½æ•¸"
                                  disabled={isReadOnly}
                                >
                                  <Minus className="w-5 h-5" />
                                </button>
                                <span className="w-8 text-center font-bold text-lg text-gray-800">{currentShares}</span>
                                <button
                                  onClick={() => handleShareChange(member, 1)}
                                  type="button"
                                  className="p-1.5 bg-green-50 text-green-600 rounded-lg transition hover:scale-105 transform hover:bg-green-100 shadow-sm border border-green-200 disabled:opacity-50 disabled:hover:scale-100"
                                  aria-label="å¢åŠ ä»½æ•¸"
                                  disabled={isReadOnly}
                                >
                                  <Plus className="w-5 h-5" />
                                </button>
                                <span className="text-sm text-gray-500 w-8 text-right">ä»½</span>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
				  </div>

				  {/* åº•éƒ¨ï¼šå›ºå®šå„²å­˜æŒ‰éˆ• (flex-shrink-0) */}
				  <div className="p-6 border-t flex justify-end flex-shrink-0">
					  <button
					    onClick={saveExpense}
					    disabled={isReadOnly || isLoadingModal || !newExpense.description.trim() || newExpense.originalAmount <= 0 || !newExpense.payerName}
					    className={
						  "flex items-center px-6 py-3 rounded-full text-white font-semibold transition duration-150 shadow-md " +
						  ((isReadOnly || isLoadingModal || !newExpense.description.trim() || newExpense.originalAmount <= 0 || !newExpense.payerName)
						    ? "bg-gray-400 cursor-not-allowed"
						    : "bg-primaryColor-600 hover:bg-primaryColor-700 hover:shadow-lg")
					    }
					  >
					    {isLoadingModal ? 'å„²å­˜ä¸­...' : (
						  <>
						    <CircleCheck className="w-5 h-5 mr-2" />
						    {submitText}
						  </>
					    )}
					  </button>
				    </div>
                </div>
              </div>
            );
        });
          
		/**
         * æˆå“¡ç®¡ç† Modal (æ ¸å¿ƒé‚è¼¯ç¨ç«‹)
         */
        const MemberManagementModal = React.memo(({ db, currentUserId, members, customMembers, defaultSharesConfig, isMemberModalOpen, setIsMemberModalOpen, saveMembers, handleSaveDefaultShares, handleDeleteMember, setIsLoading, isLoading, setError, getDisplayName, isReadOnly, groupMembers, groupOwner, inviteUserByEmail, removeGroupMember, setToastMessage }) => { 
            const [memberInput, setMemberInput] = useState('');
            const [tempDefaultShares, setTempDefaultShares] = useState({});
            // NEW: å…§éƒ¨è¨Šæ¯ç‹€æ…‹
            const [modalMessage, setModalMessage] = useState(null); 

            useEffect(() => {
                if (isMemberModalOpen) {
                    const initialShares = members.reduce((acc, name) => {
                        const shareValue = defaultSharesConfig[name] !== undefined ? defaultSharesConfig[name] : 1;
                        acc[name] = shareValue;
                        return acc;
                    }, {});
                    setTempDefaultShares(initialShares);
                    setMemberInput('');
                    setModalMessage(null); // NEW: é–‹å•Ÿæ™‚æ¸…é™¤è¨Šæ¯
                }
            }, [isMemberModalOpen, members, defaultSharesConfig]);
            
            // NEW: å…§éƒ¨è¨Šæ¯æ¸…é™¤ (é˜²æ­¢ç„¡é™è¿´åœˆ)
            const resetMessage = useCallback(() => {
                setModalMessage(null);
            }, []);

			
			// åªè™•ç†ã€Œä¸€èˆ¬æˆå“¡åç¨±ã€â†’ åŠ åˆ°åˆ†å¸³æˆå“¡åå–®
			const handleAddMemberByName = async (name) => {
			  if (isReadOnly) {
                setModalMessage('âŒ å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•æ–°å¢æˆå“¡ã€‚'); 
                return;
              }

			  const trimmedName = name.trim();
              setModalMessage(null); // æ¸…é™¤èˆŠè¨Šæ¯

			  if (
				trimmedName &&
				trimmedName !== currentUserId &&
				!customMembers.includes(trimmedName)
			  ) {
				const newMemberList = [...customMembers, trimmedName];
				await saveMembers(newMemberList);
                setModalMessage(`âœ… å·²æ–°å¢åˆ†å¸³æˆå“¡: ${trimmedName}`); 
			  } else if (trimmedName === currentUserId) {
				setModalMessage('âŒ ä¸èƒ½å°‡è‡ªå·±çš„ç”¨æˆ¶ ID æ–°å¢ç‚ºæˆå“¡ã€‚'); 
			  } else if (customMembers.includes(trimmedName)) {
                setModalMessage(`âš ï¸ æˆå“¡ ${trimmedName} å·²å­˜åœ¨æ–¼åˆ†å¸³æ¸…å–®ã€‚`); 
              }
			};

			// å…±ç”¨ï¼šåˆ¤æ–·æ˜¯åç¨±é‚„æ˜¯ Email
			const handleSubmitMemberInput = async () => {
			  if (isReadOnly) {
				setModalMessage('âŒ å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•æ–°å¢æˆ–é‚€è«‹æˆå“¡ã€‚'); 
				return;
			  }

			  const input = memberInput.trim();
			  if (!input) return;

              setModalMessage(null); // æ¸…é™¤èˆŠè¨Šæ¯

			  if (input.includes('@')) {
				// Email â†’ é‚€è«‹å…±äº«æˆå“¡
				await inviteUserByEmail(input, setModalMessage); // å‚³é setModalMessage
			  } else {
				// ä¸€èˆ¬æˆå“¡åç¨±
				await handleAddMemberByName(input);
			  }

			  setMemberInput('');
			};
            
            const handleTempShareChange = (name, delta) => {
                setTempDefaultShares(prev => {
                    const currentShares = prev[name] || 0;
                    const newShares = Math.max(0, currentShares + delta);
                    return {
                        ...prev,
                        [name]: newShares,
                    };
                });
            };
            
            const handleTempInputChange = (name, value) => {
                const shareCount = parseInt(value, 10);
                if (shareCount >= 0 || value === '') {
                    setTempDefaultShares(prev => ({
                        ...prev,
                        [name]: shareCount || 0
                    }));
                }
            };
            
            const handleMemberDeleteWrapper = async (member) => {
                if (isReadOnly) {
                    setModalMessage('âŒ å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•åˆªé™¤æˆå“¡ã€‚'); 
                    return;
                }
                await handleDeleteMember(member, setModalMessage); // å‚³é setModalMessage
            };
            
            const handleSaveDefaultSharesWrapper = async (tempShares) => {
                await handleSaveDefaultShares(tempShares, setModalMessage); // å‚³é setModalMessage
            };

            if (!isMemberModalOpen) return null;

            return (
              // æ‡‰ç”¨ force-gpu åˆ°èƒŒæ™¯å±¤
              <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-50 transition-opacity overflow-y-auto force-gpu">
                  {/* ä¿®æ­£ï¼šå°‡ max-w-2xl çš„ max-h æ”¹ç‚º h-fullï¼Œä¸¦ç¢ºä¿ flex-col å‚ç›´ä½ˆå±€ */}
                  <div className="bg-white rounded-xl w-full max-w-2xl shadow-2xl transform transition-transform duration-300 scale-100 my-4 h-full sm:h-auto sm:max-h-[95vh] flex flex-col force-gpu">
                      {/* é ‚éƒ¨ï¼šå›ºå®šæ¨™é¡Œ (flex-shrink-0) */}
                      <div className="p-6 border-b flex justify-between items-center flex-shrink-0">
                          <h3 className="text-xl font-bold text-gray-800">
                            ç®¡ç†åˆ†å¸³æˆå“¡èˆ‡é è¨­ä»½æ•¸ {isReadOnly && <span className="text-red-500 ml-2">(å”¯è®€)</span>}
                          </h3>
                          <button onClick={() => setIsMemberModalOpen(false)} className="p-1 rounded-full hover:bg-gray-100 text-gray-600 transition hover:scale-110 transform">
                              <X className="w-6 h-6" />
                          </button>
                      </div>
                      
                      {/* ä¿®æ­£ï¼šä¸­é–“å…§å®¹ï¼šå¯æ»¾å‹• (flex-1 overflow-y-auto) */}
                      <div className="p-6 space-y-6 flex-1 overflow-y-auto">
                            {/* NEW: å…§éƒ¨è¨Šæ¯é¡¯ç¤ºå€ */}
                            {modalMessage && (
                                <div className={`p-3 rounded-lg text-sm font-semibold ${modalMessage.startsWith('âŒ') ? 'bg-red-100 text-red-700' : (modalMessage.startsWith('âš ï¸') ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700')}`}>
                                    {modalMessage}
                                </div>
                            )}

							{/* æˆå“¡ç®¡ç† + å…±äº«æ¬Šé™ï¼ˆåˆä½µç‰ˆï¼‰ */}
							<div className="border p-4 rounded-lg bg-gray-50 flex-shrink-0">
							  <h4 className="font-semibold text-lg mb-2 flex items-center text-primaryColor-700">
								<Users className="w-5 h-5 mr-2" />
								ç®¡ç†åˆ†å¸³æˆå“¡èˆ‡å…±äº«æ¬Šé™
							  </h4>

							  {/* å–®ä¸€è¼¸å…¥æ¡†ï¼šåç¨± or Email */}
							  <div className="flex gap-2 items-center mb-2">
								<input
								  type="text"
								  value={memberInput}
								  onChange={(e) => setMemberInput(e.target.value)}
								  onKeyDown={(e) => {
									if (e.key === 'Enter') {
									  e.preventDefault();
									  handleSubmitMemberInput();
									}
								  }}
								  placeholder="è¼¸å…¥åç¨±æˆ–Email"
								  className="flex-grow border border-gray-300 rounded-lg p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500 disabled:bg-gray-100"
								  disabled={isLoading || isReadOnly}
								/>
								<button
								  onClick={handleSubmitMemberInput}
								  className={
									'flex-shrink-0 px-4 py-3 rounded-lg text-white font-semibold transition hover:scale-105 transform ' +
									(memberInput.trim() === '' || isLoading || isReadOnly
									  ? 'bg-gray-400 cursor-not-allowed'
									  : 'bg-primaryColor-600 hover:bg-primaryColor-700')
								  }
								  disabled={memberInput.trim() === '' || isLoading || isReadOnly}
								>
								  åŠ å…¥
								</button>
							  </div>

							  <p className="text-xs text-gray-500 mb-3">
								ä»¥EmailåŠ å…¥ï¼Œç‚ºå¯ç·¨è¼¯æˆå“¡ã€‚
							  </p>

							  {/* ç›®å‰æœ‰ç·¨è¼¯æ¬Šé™çš„æˆå“¡åˆ—è¡¨ */}
							  <div className="mt-1 text-xs text-gray-600">
								<p className="font-semibold mb-1">ç›®å‰æœ‰ç·¨è¼¯æ¬Šé™çš„æˆå“¡ï¼š</p>

								{groupMembers && groupMembers.length === 0 ? (
								  <p className="text-gray-400">å°šç„¡æˆå“¡ï¼ˆåªæœ‰ä½ è‡ªå·±ï¼‰ã€‚</p>
								) : (
								  <div className="flex flex-wrap gap-2">
									{groupMembers && groupMembers.map((uid) => (
									  <div
										key={uid}
										className="flex items-center px-2 py-1 bg-white border border-gray-300 rounded-lg text-sm"
									  >
										<span>
										  {getDisplayName(uid)}
										  {uid === groupOwner && (
											<span className="ml-1 text-[11px] text-primaryColor-600 font-semibold">
											  ï¼ˆæ“æœ‰è€…ï¼‰
											</span>
										  )}
										</span>

										{!isReadOnly && uid !== groupOwner && (
										  <button
											type="button"
											onClick={() => removeGroupMember(uid, setModalMessage)} // å‚³é setModalMessage
											className="ml-2 px-2 py-0.5 text-[11px] rounded-md border border-red-300 text-red-600 hover:bg-red-50"
										  >
											ç§»é™¤
										  </button>
										)}
									  </div>
									))}
								  </div>
								)}
							  </div>
							</div>

                          {/* ç¾æœ‰æˆå“¡åˆ—è¡¨ */}
                          <div>
                              <h4 className="font-semibold text-lg mb-3 text-gray-700">è¨­å®šæ‰€æœ‰æˆå“¡çš„é è¨­ä»½æ•¸</h4>
                              <div className="grid grid-cols-2 gap-x-4 gap-y-2 mb-3 text-sm font-semibold text-gray-600 border-b pb-2">
                                <span>æˆå“¡åç¨±</span>
                                <span className="flex items-center justify-between">é è¨­ä»½æ•¸</span>
                              </div>
                              <div className="space-y-2 max-h-64 pr-2">
                                  {members.map(member => (
                                      <div key={member} className="grid grid-cols-[1fr_auto] gap-4 items-center p-3 rounded-lg border border-gray-200 bg-white shadow-sm">
                                          <span className={`font-medium ${member === currentUserId ? 'text-primaryColor-700' : 'text-gray-800'} truncate`} title={member}>
                                              {getDisplayName(member)}
                                          </span>
                                          <div className="flex items-center space-x-2 flex-shrink">
                                            
                                            <button
                                                onClick={() => handleTempShareChange(member, -1)}
                                                type="button"
                                                className="p-1.5 bg-red-50 text-red-600 rounded-lg transition hover:scale-105 transform hover:bg-red-100 shadow-sm border border-red-200 disabled:opacity-50"
                                                aria-label="æ¸›å°‘ä»½æ•¸"
                                                disabled={isReadOnly}
                                            >
                                                <Minus className="w-5 h-5" />
                                            </button>
                                            
                                            <input
                                                key={`shares-input-${member}`} 
                                                type="number"
                                                min="0"
                                                value={tempDefaultShares[member] === 0 ? 0 : tempDefaultShares[member] || 1}
                                                onChange={(e) => handleTempInputChange(member, e.target.value)}
                                                placeholder="1"
                                                className="w-16 border border-gray-300 rounded-lg p-2 text-center focus:ring-primaryColor-500 focus:border-primaryColor-500 disabled:bg-gray-100"
                                                disabled={isLoading || isReadOnly}
                                            />
                                            
                                            <button
                                                onClick={() => handleTempShareChange(member, 1)}
                                                type="button"
                                                className="p-1.5 bg-green-50 text-green-600 rounded-lg transition hover:scale-105 transform hover:bg-green-100 shadow-sm border border-green-200 disabled:opacity-50"
                                                aria-label="å¢åŠ ä»½æ•¸"
                                                disabled={isReadOnly}
                                            >
                                                <Plus className="w-5 h-5" />
                                            </button>
                                            
                                            <span className="text-gray-500">ä»½</span>
                                            {member !== currentUserId && (
                                                <button
                                                    onClick={() => handleMemberDeleteWrapper(member)}
                                                    className="p-1 text-red-500 hover:bg-red-100 rounded-full transition hover:scale-110 transform ml-auto disabled:opacity-50"
                                                    disabled={isLoading || isReadOnly}
                                                    aria-label="åˆªé™¤æˆå“¡"
                                                >
                                                    <UserMinus className="w-5 h-5" />
                                                </button>
                                            )}
                                          </div>
                                      </div>
                                  ))}
                              </div>
                          </div>
                      </div>
                      {/* åº•éƒ¨ï¼šå›ºå®šå„²å­˜æŒ‰éˆ• (flex-shrink-0) */}
                      <div className="p-6 border-t flex justify-end flex-shrink-0">
                          <button
                              onClick={() => handleSaveDefaultSharesWrapper(tempDefaultShares)}
                              disabled={isLoading || isReadOnly}
                              className={
                                "flex items-center px-6 py-3 rounded-full text-white font-semibold transition hover:scale-105 transform duration-150 shadow-md " +
                                ((isLoading || isReadOnly)
                                  ? "bg-gray-400 cursor-not-allowed"
                                  : "bg-primaryColor-600 hover:bg-primaryColor-700 hover:shadow-lg")
                              }
                          >
                              <CircleCheck className="w-5 h-5 mr-2" />
                              å„²å­˜é è¨­ä»½æ•¸
                          </button>
                      </div>
                  </div>
              </div>
            );
        });
		
        /**
         * ä¸»è¦çš„ App å…ƒä»¶
         */
        const App = () => {
          // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [userId, setUserId] = useState(null);
          const [authReady, setAuthReady] = useState(false);
          const [userProfiles, setUserProfiles] = useState({});
		  const [lastExchangeUpdate, setLastExchangeUpdate] = useState(null);
          const [liveExchangeRates, setLiveExchangeRates] = useState(DEFAULT_EXCHANGE_RATES);
		  const [defaultCurrency, setDefaultCurrency] = useState(DEFAULT_CURRENCY);
		  const [detectedCountry, setDetectedCountry] = useState(null);
		  const [copyMessage, setCopyMessage] = useState('');
          
          const [currentCollectionId, setCurrentCollectionId] = useState(null); // ç›®å‰æ­£åœ¨æª¢è¦–çš„ groupId
		  const [currentCollectionShortCode, setCurrentCollectionShortCode] = useState(null); // åˆ†äº«ç”¨çŸ­ä»£ç¢¼
		  const [groupOwner, setGroupOwner] = useState(null);                   // ç¾¤çµ„æ“æœ‰è€… uid
		  const [groupMembers, setGroupMembers] = useState([]);                 // ç¾¤çµ„æˆå“¡ uid æ¸…å–®

		  // åªè¦ç›®å‰ç™»å…¥è€…ä¸åœ¨ groupMembers è£¡ï¼Œå°±è¦–ç‚ºå”¯è®€
		  const isReadOnly = !groupMembers.includes(userId);
		
		  const [inviteEmail, setInviteEmail] = useState(''); // ç”¨ä¾†è¼¸å…¥è¦é‚€è«‹çš„ email
		  const [groupName, setGroupName] = useState('åˆ†å¸³è¨˜å¸³ç°¿');     // é¡¯ç¤ºåœ¨ä¸Šæ–¹æ¨™é¡Œçš„åç¨±
		  const [isEditingGroupName, setIsEditingGroupName] = useState(false); 
		  const [groupNameInput, setGroupNameInput] = useState('åˆ†å¸³è¨˜å¸³ç°¿'); // ç·¨è¼¯æ™‚ä½¿ç”¨
          
          // âœ¨ NEW: æœå°‹é—œéµå­—ç‹€æ…‹
          const [searchKeyword, setSearchKeyword] = useState('');

          // âœ¨ MODIFIED: åŒ¯ç‡æ›ç®—å™¨ç‹€æ…‹ (Source and Target)
          const initialConverterSourceCurrency = localStorage.getItem('lastConverterSourceCurrency') || DEFAULT_CURRENCY;
          // å·¦é‚Šå¹£å€¼ (Source): è®€å– localStorage æˆ–é è¨­ TWD
          const [converterSourceCurrency, setConverterSourceCurrency] = useState(initialConverterSourceCurrency); 
          // å³é‚Šå¹£å€¼ (Target): é è¨­ TWDï¼Œä¸è®€å– localStorage
          const [converterTargetCurrency, setConverterTargetCurrency] = useState(DEFAULT_CURRENCY); 
          const [converterAmount, setConverterAmount] = useState('');

          // --- 0. åŒ¯ç‡æ›ç®—å™¨ä¾†æºå¹£åˆ¥æŒä¹…åŒ– ---
          // åªæœ‰ Source Currency (å·¦é‚Š) éœ€è¦è¨˜éŒ„
          useEffect(() => {
              if (converterSourceCurrency) {
                  localStorage.setItem('lastConverterSourceCurrency', converterSourceCurrency);
              }
          }, [converterSourceCurrency]);

          const [expenses, setExpenses] = useState([]);
          const [customMembers, setCustomMembers] = useState([]); 
          const [defaultSharesConfig, setDefaultSharesConfig] = useState({}); 
          const [members, setMembers] = useState([]); 
          
		  const ensureDefaultGroup = React.useCallback(async (_db, uid) => {
		    if (!_db || !uid) return null;

		    const groupId = uid; // å…ˆç”¨ uid ç•¶ groupId
		    const groupRef = _db.doc(`artifacts/${appId}/groups/${groupId}`);
		    const snap = await groupRef.get();

		    if (!snap.exists) {
			  await groupRef.set({
			    owner: uid,
			    members: [uid],
			    createdAt: serverTimestamp(),
				name: 'åˆ†å¸³è¨˜å¸³ç°¿',
			  });
		    }
		    return groupId;
		  }, []);
				  
          const [expenseModalState, setExpenseModalState] = useState({
              isOpen: false,
              editingExpense: null,
              isEditing: false,
          });
          
          const [confirmModalState, setConfirmModalState] = useState({
              isOpen: false,
              title: '',
              message: '',
              confirmText: 'ç¢ºèª',
              confirmColor: 'red',
              onConfirm: () => {},
          });

          const [isMemberModalOpen, setIsMemberModalOpen] = useState(false);
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState(null);
        
		// éŒ¯èª¤è¨Šæ¯è‡ªå‹•æ¶ˆå¤±
		useEffect(() => {
		  if (!error) return;

		  const timer = setTimeout(() => {
			setError(null);
		  }, 3000); // 3 ç§’æ¸…é™¤

		  return () => clearTimeout(timer);
		}, [error]);
		
          // --- 1. Firebase åˆå§‹åŒ–èˆ‡é©—è­‰ï¼ˆæ”¯æ´ /g/çŸ­ä»£ç¢¼ï¼‰ ---
          useEffect(() => {
            if (!firebaseConfig) {
              setError('Firebase configuration is missing.');
              setAuthReady(true);
              return;
            }

            try {
              const app = firebase.initializeApp(firebaseConfig);
              const _auth = app.auth();
              const _db = app.firestore();

              setDb(_db);
              setAuth(_auth);

              const usersCollectionPath = `artifacts/${appId}/users`;
              const usersRef = _db.collection(usersCollectionPath);

              const unsubscribe = _auth.onAuthStateChanged(async (user) => {
                try {
                  if (user) {
                    setUserId(user.uid);

                    // 1. å…ˆå¹«ç™»å…¥è€…è‡ªå·±å»ºç«‹ / è£œä¸ŠçŸ­ä»£ç¢¼
                    let myShortCode = null;
                    try {
                      const myDocRef = usersRef.doc(user.uid);
                      const mySnap = await myDocRef.get();
                      if (mySnap.exists) {
                        const data = mySnap.data() || {};
                        myShortCode = data.shortCode || null;
                      }
                      if (!myShortCode) {
                        myShortCode = generateShortCode();
                        await myDocRef.set(
                          {
                            shortCode: myShortCode,
                            createdAt: serverTimestamp(),
                          },
                          { merge: true }
                        );
                      }
                    } catch (err) {
                      console.error('åˆå§‹åŒ–ä½¿ç”¨è€…çŸ­ä»£ç¢¼å¤±æ•—ï¼š', err);
                    }

                    // 2. è§£æç¶²å€ï¼šå„ªå…ˆæ”¯æ´ /g/SHORTï¼Œå…¶æ¬¡èˆŠç‰ˆ ?shareId=
                    const url = new URL(window.location.href);
                    const urlParams = url.searchParams;
                    const shareId = urlParams.get('shareId');

                    let shortCodeFromPath = null;
                    const path = url.pathname || '';
                    const marker = '/g/';
                    const idx = path.indexOf(marker);
                    if (idx !== -1) {
                      const after = path.slice(idx + marker.length);
                      shortCodeFromPath = after.split('/')[0] || null;
                    }

                    let targetCollectionId = user.uid;
                    let targetShortCode = myShortCode || null;

                    if (shortCodeFromPath) {
                      try {
                        // ç”¨çŸ­ä»£ç¢¼æŸ¥å‡ºæ“æœ‰è€…çš„ userId
                        const snap = await usersRef
                          .where('shortCode', '==', shortCodeFromPath)
                          .limit(1)
                          .get();
                        if (!snap.empty) {
                          const doc = snap.docs[0];
                          targetCollectionId = doc.id;
                          const data = doc.data() || {};
                          targetShortCode = data.shortCode || shortCodeFromPath;
                        } else {
                          setError('æ‰¾ä¸åˆ°å°æ‡‰çš„åˆ†å¸³ç°¿ï¼Œå·²åˆ‡å›è‡ªå·±çš„ç´€éŒ„ç°¿ã€‚');
                        }
                      } catch (err) {
                        console.error('ä¾çŸ­ä»£ç¢¼å°‹æ‰¾åˆ†å¸³ç°¿å¤±æ•—ï¼š', err);
                        setError('é€£çµè¼‰å…¥å¤±æ•—ï¼Œå·²åˆ‡å›è‡ªå·±çš„ç´€éŒ„ç°¿ã€‚');
                      }
                    } else if (shareId) {
                      // èˆŠç‰ˆé€£çµï¼š?shareId=UID é‚„æ˜¯å¯ä»¥ç”¨
                      targetCollectionId = shareId;
                      // æ¸…æ‰èˆŠç‰ˆ queryï¼Œé¿å…ä¹‹å¾Œé‡è¤‡è§£æ
                      window.history.replaceState(null, '', url.pathname);
                    }

                    setCurrentCollectionId((prev) => prev || targetCollectionId);
                    setCurrentCollectionShortCode(targetShortCode);
                  } else {
                    setUserId(null);
                    setCurrentCollectionId(null);
                    setCurrentCollectionShortCode(null);
                  }
                } finally {
                  setAuthReady(true);
                }
              });

              return () => unsubscribe();
            } catch (e) {
              setError(`Firebase initialization failed: ${e.message}`);
              setAuthReady(true);
            }
          }, []);

		// --- ç›£è½ç›®å‰ group çš„ owner / members ---
		useEffect(() => {
		  if (!db || !currentCollectionId) return;

		  const groupDocRef = db.doc(`artifacts/${appId}/groups/${currentCollectionId}`);

		  const unsub = groupDocRef.onSnapshot(
			(snap) => {
			  if (snap.exists) {
				const data = snap.data();
				const owner = data.owner || null;
				const members = Array.isArray(data.members) ? data.members : [];

				// owner ä¹Ÿç¢ºä¿åœ¨ members è£¡ï¼ˆé¿å… owner ä¸è¦‹ï¼‰
				const mergedMembers = members.includes(owner)
				  ? members
				  : [...members, owner].filter(Boolean);
				  
				const nameFromDb = data.name || 'åˆ†å¸³è¨˜å¸³ç°¿';

				setGroupOwner(owner);
				setGroupMembers(mergedMembers);
				setGroupName(nameFromDb);
				setGroupNameInput(nameFromDb);
			  } else {
				console.warn("Group doc not found:", currentCollectionId);
				setGroupOwner(null);
				setGroupMembers([]);
				setGroupName('åˆ†å¸³è¨˜å¸³ç°¿');
				setGroupNameInput('åˆ†å¸³è¨˜å¸³ç°¿');
			  }
			},
			(err) => {
			  console.error("Error listening group doc:", err);
			  setGroupOwner(null);
			  setGroupMembers([]);
			}
		  );

		  return () => unsub();
		}, [db, currentCollectionId]);

		// é–‹å§‹ç·¨è¼¯ç¾¤çµ„åç¨±ï¼ˆåªæœ‰æˆå“¡å¯ä»¥ç·¨ï¼‰
		const startEditGroupName = () => {
		  if (isReadOnly) return; // éæˆå“¡ä¸èƒ½æ”¹
		  setGroupNameInput(groupName || 'åˆ†å¸³è¨˜å¸³ç°¿');
		  setIsEditingGroupName(true);
		};

		// å–æ¶ˆä¿®æ”¹
		const cancelEditGroupName = () => {
		  setIsEditingGroupName(false);
		  setGroupNameInput(groupName || 'åˆ†å¸³è¨˜å¸³ç°¿');
		};

		// å„²å­˜åç¨±åˆ° Firestore
		const saveGroupName = async () => {
		  if (!db || !currentCollectionId) return;
		  if (isReadOnly) return;

		  const trimmed = (groupNameInput || '').trim() || 'æœªå‘½åè¨˜å¸³ç°¿';

		  try {
			setIsLoading(true);
			setError(null);

			const groupRef = db.doc(`artifacts/${appId}/groups/${currentCollectionId}`);
			await groupRef.set(
			  {
				name: trimmed,
			  },
			  { merge: true }
			);

			setGroupName(trimmed);
			setGroupNameInput(trimmed);
			setIsEditingGroupName(false);
		  } catch (e) {
			console.error('saveGroupName error:', e);
			setError(`æ›´æ–°ç´€éŒ„ç°¿åç¨±å¤±æ•—ï¼š${e.message}`);
		  } finally {
			setIsLoading(false);
		  }
		};

          // --- 2. ç²å–æ‰€æœ‰å…¬å…±æš±ç¨± ---
          useEffect(() => {
            if (!authReady || !db) return;
            
            const profilesCollectionPath = `artifacts/${appId}/public_profiles`;
            const profilesRef = db.collection(profilesCollectionPath);

            const unsubscribeProfiles = profilesRef.onSnapshot((snapshot) => {
                const profiles = {};
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.uid && data.displayName) {
                        profiles[data.uid] = data.displayName;
                    }
                });
                setUserProfiles(profiles);
            }, (err) => {
                console.error("Error listening to user profiles:", err);
            });

            return () => unsubscribeProfiles();
          }, [authReady, db]);

          // --- 3. ç²å–å¯¦æ™‚åŒ¯ç‡ ---
          useEffect(() => {
			fetchExchangeRates().then(result => {
				setLiveExchangeRates(result.rates);
				setLastExchangeUpdate(result.lastUpdate);
			});
		  }, []);

			// ç™»å‡ºï¼ˆæ”¹ç”¨ confirm modalï¼Œè€Œä¸æ˜¯ window.confirmï¼‰
			const logout = useCallback(() => {
			  if (!auth) return;

			  const onConfirm = async () => {
				closeConfirmModal();
				try {
				  await auth.signOut();
				  setExpenses([]);
				  setCustomMembers([]);
				  setDefaultSharesConfig({});
				} catch (e) {
				  setError(`ç™»å‡ºå¤±æ•—: ${e.message}`);
				}
			  };

			  openConfirmModal(
				'ç¢ºèªç™»å‡º',
				'æ‚¨ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ',
				onConfirm
			  );
			}, [
			  auth,
			  openConfirmModal,
			  closeConfirmModal,
			  setExpenses,
			  setCustomMembers,
			  setDefaultSharesConfig,
			  setError
			]);

          // --- 4. æ•¸æ“šç²å– (Firestore ç›£è½) ---
          useEffect(() => {
            if (!authReady || !db || !currentCollectionId) return; 

            const expensesCollectionPath = getGroupExpensesPath(currentCollectionId);
			const expensesRef = db.collection(expensesCollectionPath);

            const unsubscribeExpenses = expensesRef.onSnapshot((snapshot) => {
              const fetchedExpenses = snapshot.docs.map(docSnap => {
                const data = docSnap.data();
                const timestamp = data.timestamp ? data.timestamp.toDate() : null; 
                
                const originalAmount = data.originalAmount !== undefined ? data.originalAmount : data.amount;
                const currency = data.currency || DEFAULT_CURRENCY;
                const exchangeRate = data.exchangeRate || (DEFAULT_EXCHANGE_RATES[currency] || 1.0);
                const amountInTWD = data.amountInTWD !== undefined ? data.amountInTWD : originalAmount * exchangeRate;

                return {
                  id: docSnap.id, 
                  ...data,
                  originalAmount: typeof originalAmount === 'number' ? originalAmount : parseFloat(originalAmount || 0),
                  currency: currency,
                  exchangeRate: exchangeRate,
                  amountInTWD: typeof amountInTWD === 'number' ? amountInTWD : parseFloat(amountInTWD || 0),
                  shares: data.shares || {},
                  timestamp: timestamp,
                };
              });
              setExpenses(fetchedExpenses);
            }, (err) => {
              console.error(`Error listening to expenses in collection ${currentCollectionId}:`, err);
              if (err.code === 'permission-denied') {
                  setError(`æ¬Šé™ä¸è¶³ï¼šç„¡æ³•è®€å–æ­¤åˆ†äº«é€£çµå°æ‡‰çš„ç´€éŒ„ç°¿ï¼ˆID: ${currentCollectionId}ï¼‰ã€‚è«‹æ´½æ“æœ‰è€…ç¢ºèªæ¬Šé™ã€‚`);
              } else {
                  setError(`è³‡æ–™åŒæ­¥å¤±æ•—: ${err.message}`);
              }
              setExpenses([]);
            });

            const membersDocPath = getGroupMembersDocPath(currentCollectionId);
			const membersDocRef = db.doc(membersDocPath);

            const unsubscribeMembers = membersDocRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    const data = docSnap.data();
                    const list = Array.isArray(data.list) ? data.list : [];
                    const shares = data.defaultShares || {};
                    
                    setCustomMembers(list);
                    setDefaultSharesConfig(shares); 
                } else {
                    setCustomMembers([]);
                    setDefaultSharesConfig({}); 
                }
            }, (err) => {
                console.error("Error listening to members settings:", err);
            });

            return () => {
              unsubscribeExpenses();
              unsubscribeMembers();
            };
          }, [authReady, db, currentCollectionId]);

          // --- 5. è¡ç”Ÿæˆå“¡æ¸…å–® ---
			useEffect(() => {
			  let currentMembers = [currentCollectionId].filter(Boolean); 
			  
			  customMembers.forEach(name => {
				if (name !== currentCollectionId && !currentMembers.includes(name)) {
				  currentMembers.push(name);
				}
			  });

			  setMembers(currentMembers);
			}, [currentCollectionId, customMembers]);

          const getInitialShares = useCallback(() => {
            return members.reduce((acc, name) => {
                const shareValue = defaultSharesConfig[name] !== undefined ? defaultSharesConfig[name] : 1;
                acc[name] = shareValue;
                return acc;
            }, {});
          }, [members, defaultSharesConfig]);

          // --- Modal é–‹é—œ ---
          const openConfirmModal = useCallback((title, message, onConfirm, confirmText = 'ç¢ºèª', confirmColor = 'red') => {
              setConfirmModalState({
                  isOpen: true,
                  title,
                  message,
                  confirmText,
                  confirmColor,
                  onConfirm,
              });
          }, []);

          const closeConfirmModal = useCallback(() => {
              setConfirmModalState(prev => ({ ...prev, isOpen: false }));
          }, []);

          const startAdd = useCallback(() => {
            if (isReadOnly) {
                setError('æ‚¨æ­£åœ¨ç€è¦½å…±äº«ç´€éŒ„ç°¿ï¼Œç„¡æ³•é€²è¡Œä¿®æ”¹ã€‚è«‹åˆ‡æ›å›æ‚¨çš„ç§æœ‰ç´€éŒ„ç°¿ã€‚');
                return;
            }
            setExpenseModalState({
                isOpen: true,
                editingExpense: null,
                isEditing: false,
            });
          }, [isReadOnly]);
          
          const startEdit = useCallback((expense) => {
             if (isReadOnly) {
                setError('æ‚¨æ­£åœ¨ç€è¦½å…±äº«ç´€éŒ„ç°¿ï¼Œç„¡æ³•é€²è¡Œä¿®æ”¹ã€‚è«‹åˆ‡æ›å›æ‚¨çš„ç§æœ‰ç´€éŒ„ç°¿ã€‚');
                return;
             }
             setExpenseModalState({
                isOpen: true,
                editingExpense: expense,
                isEditing: true,
             });
          }, [isReadOnly]);

          const closeExpenseModal = useCallback(() => {
            setExpenseModalState({
                isOpen: false,
                editingExpense: null,
                isEditing: false,
            });
            setError(null);
          }, []);

          // --- 6. æ”¯å‡º CRUD ---

          const deleteExpense = useCallback(async (id) => {
            if (isReadOnly) {
                setError('å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•åˆªé™¤ã€‚');
                return;
            }
            if (!db) return;

            const onConfirm = async () => {
                closeConfirmModal();
                setIsLoading(true);
                setError(null);
                try {
                    const docPath = `${getGroupExpensesPath(currentCollectionId)}/${id}`;
                    await db.doc(docPath).delete();
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    setError(`åˆªé™¤æ”¯å‡ºå¤±æ•—: ${e.message}`);
                } finally {
                    setIsLoading(false);
                }
            };
            
            openConfirmModal('ç¢ºèªåˆªé™¤æ”¯å‡º', 'æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚', onConfirm);
          }, [db, currentCollectionId, isReadOnly, openConfirmModal, closeConfirmModal]);

          const clearAllExpenses = useCallback(async () => {
              if (isReadOnly) {
                  setError('å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•æ¸…é™¤è³‡æ–™ã€‚');
                  return;
              }
              if (!db) return;

              const onConfirm = async () => {
                  closeConfirmModal();
                  setIsLoading(true);
                  setError(null);
                  try {
                      const expensesCollectionPath = getGroupExpensesPath(currentCollectionId);
                      const snapshot = await db.collection(expensesCollectionPath).get();

                      const batch = db.batch();
                      snapshot.docs.forEach(doc => {
                          batch.delete(doc.ref);
                      });
                      await batch.commit();
                  } catch (e) {
                      console.error("Error clearing all documents: ", e);
                      setError(`æ¸…é™¤æ‰€æœ‰è³‡æ–™å¤±æ•—: ${e.message}`);
                  } finally {
                      setIsLoading(false);
                  }
              };

              openConfirmModal(
                  'ç¢ºèªæ¸…é™¤æ‰€æœ‰æ”¯å‡º', 
                  'æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜å¸³ç°¿ä¸­çš„æ‰€æœ‰æ”¯å‡ºè¨˜éŒ„å—ï¼Ÿ', 
                  onConfirm
              );
          }, [db, currentCollectionId, isReadOnly, openConfirmModal, closeConfirmModal]);

          // --- 7. æˆå“¡ç®¡ç† ---
          const saveMembers = useCallback(async (newMemberList) => {
            if (isReadOnly) return;
            if (!db) return;

            setIsLoading(true);
            setError(null);
            try {
                const docPath = getGroupMembersDocPath(currentCollectionId);
                const membersDocRef = db.doc(docPath);

                const sanitizedList = Array.from(new Set(
                    newMemberList.filter(name => name.trim() !== '' && name !== currentCollectionId)
                ));

                const currentShares = {};
                members.forEach(name => {
                    const share = defaultSharesConfig[name] !== undefined ? defaultSharesConfig[name] : 1;
                    if (share !== 1 && share >= 0) {
                        currentShares[name] = share;
                    }
                });

                await membersDocRef.set({ list: sanitizedList, defaultShares: currentShares }, { merge: false });
            } catch (e) {
                console.error("Error saving members:", e);
                setError(`å„²å­˜æˆå“¡æ¸…å–®å¤±æ•—: ${e.message}`);
            } finally {
                setIsLoading(false);
            }
          }, [db, currentCollectionId, isReadOnly, members, defaultSharesConfig]);

			// é€é email é‚€è«‹ä½¿ç”¨è€…åŠ å…¥é€™å€‹ç¾¤çµ„ï¼ˆæœ‰ç·¨è¼¯æ¬Šï¼‰
			// NEW: å‚³å…¥ setModalMessage
			const inviteUserByEmail = React.useCallback(
			  async (emailToInviteRaw, setModalMessage) => { 
				if (!db || !currentCollectionId) return;
				const emailToInvite = (emailToInviteRaw || '').trim().toLowerCase();
				if (!emailToInvite) return;

				setIsLoading(true);
				setError(null);

				try {
				  // 1) ç”¨ email æ‰¾ public_profiles
				  const profilesRef = db.collection(`artifacts/${appId}/public_profiles`);
				  const snap = await profilesRef.where('email', '==', emailToInvite).get();

				  if (snap.empty) {
					setModalMessage('âŒ æ‰¾ä¸åˆ°ä½¿ç”¨é€™å€‹ Email è¨»å†Šçš„å¸³è™Ÿï¼Œè«‹å°æ–¹å…ˆåœ¨é€™å€‹ç³»çµ±ç™»å…¥ä¸€æ¬¡ã€‚'); // ä½¿ç”¨ Modal Message
					return;
				  }

				  const profileData = snap.docs[0].data();
				  const invitedUid = profileData.uid;
				  const invitedDisplayName =
					profileData.displayName || profileData.nickname || emailToInvite;

				  if (!invitedUid) {
					setError('é€™å€‹ Email çš„ä½¿ç”¨è€…è³‡æ–™ç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'); 
					return;
				  }

				  // 2) æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯æˆå“¡ï¼šå¦‚æœæ˜¯ï¼Œæç¤ºå°±å¥½ï¼Œä¸è¦é‡è¤‡åŠ å…¥
				  if (groupMembers.includes(invitedUid)) {
					setModalMessage(`âŒ ã€Œ${invitedDisplayName}ã€å·²ç¶“æ˜¯é€™æœ¬è¨˜å¸³ç°¿çš„æˆå“¡äº†ã€‚`); // ä½¿ç”¨ Modal Message
					return;
				  }

				  // 3) æŠŠ uid åŠ é€² group.members
				  const groupRef = db.doc(`artifacts/${appId}/groups/${currentCollectionId}`);
				  await groupRef.update({
					members: firebase.firestore.FieldValue.arrayUnion(invitedUid),
				  });

				  // 4) æŠŠä»–ä¹ŸåŠ å…¥ã€Œåˆ†å¸³æˆå“¡åå–®ã€ï¼ˆsettings/members.listï¼‰
				  let newMemberList = customMembers;
				  if (!customMembers.includes(invitedUid)) {
					newMemberList = [...customMembers, invitedUid];
					await saveMembers(newMemberList);
				  }

				  // 5) æ¸…ç©ºè¼¸å…¥æ¡† and Success Message
				  setInviteEmail('');
				  setModalMessage(`âœ… å·²æˆåŠŸé‚€è«‹æˆå“¡: ${invitedDisplayName}`); // æˆåŠŸ Modal Message
				  console.log(
					`å·²é‚€è«‹æˆå“¡ ${invitedDisplayName} (${invitedUid}) ä¸¦åŠ å…¥åˆ†å¸³æˆå“¡åå–®`
				  );
				} catch (e) {
				  console.error('inviteUserByEmail error:', e);
				  setError(`é‚€è«‹æˆå“¡å¤±æ•—: ${e.message}`); 
				} finally {
				  setIsLoading(false);
				}
			  },
			  [db, currentCollectionId, customMembers, saveMembers, groupMembers]
			);

			// å¾ç¾¤çµ„ä¸­ç§»é™¤æˆå“¡ï¼ˆåŒæ™‚å¾åˆ†å¸³æˆå“¡åå–®ä¸­ç§»é™¤ï¼‰
			// NEW: å‚³å…¥ setModalMessageï¼Œè®“ç§»é™¤æˆåŠŸçš„è¨Šæ¯é¡¯ç¤ºåœ¨ Modal å…§éƒ¨
			const removeGroupMember = React.useCallback(
			  (memberUid, setModalMessage) => {
				if (isReadOnly) return;

				// ä¸å…è¨±ç§»é™¤ owner
				if (memberUid === groupOwner) {
				  setError('ç„¡æ³•ç§»é™¤æ“æœ‰è€…ã€‚å¦‚éœ€è®Šæ›´ï¼Œè«‹å…ˆç§»è½‰æˆ–å»ºç«‹æ–°çš„è¨˜å¸³ç°¿ã€‚');
				  return;
				}

				const onConfirm = async () => {
				  closeConfirmModal();
				  try {
					setIsLoading(true);
					setError(null);

					// 1) å¾ group.members ç§»é™¤
					const groupRef = db.doc(`artifacts/${appId}/groups/${currentCollectionId}`);
					await groupRef.update({
					  members: firebase.firestore.FieldValue.arrayRemove(memberUid),
					});

					// 2) å¾åˆ†å¸³æˆå“¡åˆ—è¡¨ç§»é™¤
					const newMemberList = customMembers.filter(id => id !== memberUid);
					await saveMembers(newMemberList);
                    if (setModalMessage) setModalMessage(`ğŸ—‘ï¸ å·²ç§»é™¤å…±äº«æˆå“¡: ${getDisplayName(memberUid)}`);

				  } catch (e) {
					console.error('removeGroupMember error:', e);
					setError(`ç§»é™¤æˆå“¡å¤±æ•—ï¼š${e.message}`);
				  } finally {
					setIsLoading(false);
				  }
				};

				openConfirmModal(
				  'ç¢ºèªç§»é™¤å…±äº«æˆå“¡',
				  `ç¢ºå®šè¦ç§»é™¤æˆå“¡ã€Œ${getDisplayName(memberUid)}ã€å—ï¼Ÿ`,
				  onConfirm
				);
			  },
			  [
				db,
				currentCollectionId,
				isReadOnly,
				groupOwner,
				customMembers,
				saveMembers,
				openConfirmModal,
				closeConfirmModal,
				getDisplayName,
				setError,
				setIsLoading
			  ]
			);

          // NEW: è®“ handleDeleteMember å›å‚³è¨Šæ¯çµ¦ Modal
          const handleDeleteMember = useCallback(async (nameToDelete, setModalMessage) => {
            if (isReadOnly) return;
            
            const onConfirm = async () => {
                closeConfirmModal();
                const newMemberList = customMembers.filter(name => name !== nameToDelete);
                await saveMembers(newMemberList);
                if (setModalMessage) setModalMessage(`ğŸ—‘ï¸ å·²å¾åˆ†å¸³æ¸…å–®ç§»é™¤: ${getDisplayName(nameToDelete)}`);
            };

            openConfirmModal(
                'ç¢ºèªåˆªé™¤æˆå“¡', 
                `æ‚¨ç¢ºå®šè¦å¾æˆå“¡æ¸…å–®ä¸­ç§»é™¤ ${getDisplayName(nameToDelete)} å—ï¼Ÿ`, 
                onConfirm
            );

          }, [customMembers, saveMembers, isReadOnly, openConfirmModal, closeConfirmModal, getDisplayName]);

          // NEW: è®“ handleSaveDefaultShares å›å‚³è¨Šæ¯çµ¦ Modal
          const handleSaveDefaultShares = useCallback(async (tempShares, setModalMessage) => {
            if (isReadOnly) return;
            if (!db) return;

            setIsLoading(true);
            setError(null);
            try {
                const docPath = getGroupMembersDocPath(currentCollectionId);
                const membersDocRef = db.doc(docPath);

                const sharesToSave = {};
                members.forEach(name => {
                    const share = tempShares[name]; 
                    if (share !== undefined && share >= 0) {
                        if (share !== 1) { 
                            sharesToSave[name] = share;
                        }
                    }
                });
                
                await membersDocRef.set({ list: customMembers, defaultShares: sharesToSave }, { merge: false });
                setIsMemberModalOpen(false);
                if (setModalMessage) setModalMessage(`âœ… é è¨­ä»½æ•¸å·²å„²å­˜ï¼`);
            } catch (e) {
                console.error("Error saving default shares:", e);
                setError(`å„²å­˜é è¨­ä»½æ•¸å¤±æ•—: ${e.message}`);
            } finally {
                setIsLoading(false);
            }
          }, [db, currentCollectionId, customMembers, members, isReadOnly]);

          // --- 8. æ¸…ç®—çµé¤˜åŠŸèƒ½ ---
          const settleMemberDebt = useCallback(async (debtorId, amount, creditorId) => {
              if (isReadOnly) {
                  setError('å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•é€²è¡Œçµç®—æ“ä½œã€‚');
                  return;
              }
              if (!db || !userId) return;

              const roundedAmount = Math.round(amount);
              if (roundedAmount <= 0) return;

              const onConfirm = async () => {
                  closeConfirmModal();
                  setIsLoading(true);
                  setError(null);
                  try {
                      const collectionPath = getGroupExpensesPath(currentCollectionId);
                      
                      // ä½¿ç”¨æ–°æ¬„ä½æ ¼å¼ï¼šoriginalAmount / currency / amountInTWD
                      await db.collection(collectionPath).add({
                          description: `[çµæ¸…] ${getDisplayName(debtorId)} æ­¸é‚„çµ¦ ${getDisplayName(creditorId)} æ¬ æ¬¾`,
                          originalAmount: roundedAmount,
                          currency: DEFAULT_CURRENCY,
                          exchangeRate: 1,
                          amountInTWD: roundedAmount,
                          payerName: debtorId,
                          shares: { [creditorId]: roundedAmount },
                          timestamp: serverTimestamp(),
                          creatorId: userId,
                          appId: appId,
                      });
                      setToastMessage(`âœ… å·²æ–°å¢çµæ¸…è¨˜éŒ„ TWD ${roundedAmount.toFixed(0)}ï¼`); // çµç®—æˆåŠŸ Toast
                  } catch (e) {
                      console.error("Error settling debt: ", e);
                      setError(`çµç®—å¤±æ•—: ${e.message}`);
                  } finally {
                      setIsLoading(false);
                  }
              };
              
              openConfirmModal(
                  'ç¢ºèªè½‰å¸³çµæ¸…', 
                  `æ‚¨ç¢ºå®š ${getDisplayName(debtorId)} å·²å‘ ${getDisplayName(creditorId)} æ”¯ä»˜ TWD ${roundedAmount.toFixed(0)} ä¸¦çµæ¸…æ¬ æ¬¾å—ï¼Ÿ`, 
                  onConfirm, 
                  'ç¢ºèªçµæ¸…', 
                  'green'
              );

          }, [db, userId, currentCollectionId, isReadOnly, getDisplayName, openConfirmModal, closeConfirmModal]);

          // --- 9. åˆ†å¸³è¨ˆç®— ---
          const calculateBalances = useMemo(() => {
            const balances = members.reduce((acc, name) => ({ ...acc, [name]: 0 }), {});

            expenses.forEach(expense => {
              const amount = expense.amountInTWD; 
              const { payerName, shares } = expense;
              const totalShares = Object.values(shares).reduce((sum, s) => sum + s, 0);

              if (totalShares === 0) return;

              const costPerShare = amount / totalShares;

              if (balances[payerName] !== undefined) {
                balances[payerName] += amount;
              }

              Object.entries(shares).forEach(([member, shareCount]) => {
                const memberCost = costPerShare * shareCount;
                if (balances[member] !== undefined) {
                  balances[member] -= memberCost;
                }
              });
            });

            return balances;
          }, [expenses, members]);

          const calculateSettlements = useMemo(() => {
            const balances = calculateBalances;
            const settlements = [];

            const creditors = []; 
            const debtors = []; 

            const mutableBalances = { ...balances };

            for (const member in mutableBalances) {
                const balance = mutableBalances[member];
                if (balance >= 1) { 
                    creditors.push({ name: member, amount: balance });
                } else if (balance <= -1) { 
                    debtors.push({ name: member, amount: -balance }); 
                }
            }

            let i = 0; 
            let j = 0; 

            while (i < debtors.length && j < creditors.length) {
                const debtor = debtors[i];
                const creditor = creditors[j];

                const transferAmount = Math.round(Math.min(debtor.amount, creditor.amount));

                if (transferAmount > 0) {
                    settlements.push({
                        from: debtor.name,
                        to: creditor.name,
                        amount: transferAmount,
                    });
                }

                debtor.amount -= transferAmount;
                creditor.amount -= transferAmount;

                if (debtor.amount < 1) { 
                    i++;
                }
                if (creditor.amount < 1) {
                    j++;
                }
            }
            
            return settlements;
          }, [calculateBalances]); 

          // --- 10. UI è¼”åŠ© ---
          // NEW: é€šç”¨ Toast è¨Šæ¯è¨­å®šå‡½å¼ (åŒ…å«å®šæ™‚æ¸…é™¤)
          const setToastMessage = React.useCallback((message) => {
            setCopyMessage(message); 
            if (message) {
                // è¨­å®š 4 ç§’å¾Œè‡ªå‹•æ¸…é™¤
                setTimeout(() => setCopyMessage(''), 4000); 
            }
          }, []); 

          const getDisplayName = useCallback((memberId) => {
            if (userProfiles[memberId]) {
                return userProfiles[memberId];
            }
            
            if (memberId === userId) {
                const currentUser = auth?.currentUser;
                return currentUser?.displayName || currentUser?.email || 'æˆ‘ (You)';
            }
            
            if (memberId === currentCollectionId && memberId) {
                const shortId = memberId.substring(0, 5) + '...' + memberId.substring(memberId.length - 5);
                return shortId;
            }
            
            return memberId;
          }, [userId, auth, currentCollectionId, userProfiles]);
          
          const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'ç„¡æ—¥æœŸ';
            const date = timestamp instanceof Date ? timestamp : (timestamp.toDate ? timestamp.toDate() : null);
            if (!date) return 'ç„¡æ—¥æœŸ';

            return date.toLocaleDateString('zh-TW', {
              year: 'numeric',
              month: 'numeric',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            });
          };

          // --- è¨ˆç®—æ›ç®—çµæœ ---
          const convertedAmount = useMemo(() => {
              const amount = parseFloat(converterAmount) || 0;
              if (amount <= 0) return 0;

              // Step 1: Convert source amount to TWD
              const rateToTWD = liveExchangeRates[converterSourceCurrency] || 1.0;
              const amountInTWD = amount * rateToTWD;

              // Step 2: Convert TWD to target currency
              const rateToTarget = liveExchangeRates[converterTargetCurrency] || 1.0;
              
              if (rateToTarget === 0) return 0; // Avoid division by zero
              
              // 1 Target Currency = X TWD (rateToTarget)
              // 1 TWD = 1 / rateToTarget Target Currency
              const targetAmount = amountInTWD / rateToTarget;
              
              // æ›ç®—çµæœå››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œå…©ä½ (ç‚ºäº†ç²¾æº–åº¦ï¼Œä¸åƒåˆ†å¸³åªå–æ•´æ•¸)
              return parseFloat(targetAmount.toFixed(2));

          }, [converterAmount, converterSourceCurrency, converterTargetCurrency, liveExchangeRates]);

			// --- æ¸²æŸ“ ---
			const currentUserLabel = userId ? getDisplayName(userId) : '';
			const isViewingOwn = currentCollectionId === userId;

			// è¤‡è£½åˆ†äº«é€£çµï¼ˆç§»åˆ° header ä½¿ç”¨ï¼‰
			const handleCopyShareLink = React.useCallback(() => {
			  if (!userId || !currentCollectionId || !currentCollectionShortCode) return;

			  // ä¿®æ­£ç‚ºè¤‡è£½çŸ­ä»£ç¢¼è·¯å¾‘é€£çµ
			  const url = new URL(window.location.href);
			  let rootPath = url.pathname;
			  const marker = '/g/';
			  const idx = rootPath.indexOf(marker);
			  if (idx !== -1) {
				rootPath = rootPath.slice(0, idx);
			  }
			  if (!rootPath.endsWith('/')) {
				rootPath = rootPath + '/';
			  }
			  // çµ„è£æ–°çš„çŸ­ä»£ç¢¼åˆ†äº«é€£çµ
			  const shareUrl = `${window.location.origin}${rootPath}g/${currentCollectionShortCode}`;

			  const tempInput = document.createElement('textarea');
			  tempInput.value = shareUrl;
			  document.body.appendChild(tempInput);
			  tempInput.select();

			  try {
				document.execCommand('copy');
				setToastMessage('âœ¨ åˆ†äº«é€£çµå·²è¤‡è£½ï¼');
			  } catch (err) {
				console.error('ç„¡æ³•è¤‡è£½é€£çµ', err);
				setToastMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ç¶²å€ã€‚');
			  }

			  document.body.removeChild(tempInput);
			}, [userId, currentCollectionId, currentCollectionShortCode, setToastMessage]);

			// è¿”å›è‡ªå·±çš„è¨˜å¸³ç°¿ï¼ˆåŠ å…¥ confirm modalï¼‰
			const handleReturnToOwn = React.useCallback(() => {
			  if (!db || !userId) return;

			  const onConfirm = async () => {
				closeConfirmModal();

				try {
				  setIsLoading(true);
				  setError(null);

				  const usersCollectionPath = `artifacts/${appId}/users`;
				  const usersRef = db.collection(usersCollectionPath);
				  const myDocRef = usersRef.doc(userId);
				  const mySnap = await myDocRef.get();

				  let myShortCode = null;

				  if (mySnap.exists) {
					const data = mySnap.data() || {};
					myShortCode = data.shortCode || null;
				  }

				  // å¦‚æœé‚„æ²’æœ‰ shortCodeï¼Œå°±å¹«è‡ªå·±ç”¢ç”Ÿä¸€å€‹
				  if (!myShortCode) {
					myShortCode = generateShortCode();
					await myDocRef.set(
					  {
						shortCode: myShortCode,
						createdAt: serverTimestamp(),
					  },
					  { merge: true }
					);
				  }

				  // åˆ‡å›è‡ªå·±çš„ç´€å¸³ç°¿
				  setCurrentCollectionId(userId);
				  setCurrentCollectionShortCode(myShortCode);

				  // æ›´æ–°ç¶²å€ç‚º /g/è‡ªå·±çš„ shortCodeï¼ˆä¸é‡æ•´é é¢ï¼‰
				  const url = new URL(window.location.href);
				  let rootPath = url.pathname;
				  const marker = '/g/';
				  const idx = rootPath.indexOf(marker);
				  if (idx !== -1) {
					rootPath = rootPath.slice(0, idx);
				  }
				  if (!rootPath.endsWith('/')) {
					rootPath = rootPath + '/';
				  }
				  const newUrl = `${rootPath}g/${myShortCode}`;
				  window.history.replaceState(null, '', newUrl);
				} catch (e) {
				  console.error('handleReturnToOwn error:', e);
				  setError(`è¿”å›è‡ªå·±çš„è¨˜å¸³ç°¿å¤±æ•—ï¼š${e.message}`);
				} finally {
				  setIsLoading(false);
				}
			  };

			  openConfirmModal(
				'è¿”å›è‡ªå·±çš„è¨˜å¸³ç°¿',
				'ç¢ºå®šè¦è¿”å›è‡ªå·±çš„è¨˜å¸³ç°¿å—ï¼Ÿ',
				onConfirm
			  );
			}, [
			  db,
			  userId,
			  openConfirmModal,
			  closeConfirmModal,
			  setIsLoading,
			  setError,
			  setCurrentCollectionId,
			  setCurrentCollectionShortCode,
			]);

          if (!authReady) {
            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                    <p className="text-lg text-primaryColor-600">è¼‰å…¥é©—è­‰æœå‹™...</p>
                </div>
            );
          }
          
          if (!userId || !auth) {
            return <AuthModal auth={auth} db={db} setToastMessage={setToastMessage} />;
          }

		  return (
            <div className="min-h-screen bg-gray-50 p-4 sm:p-8">
              <div className="max-w-4xl mx-auto">
                {/* æ¨™é¡Œå’Œä¸»è¦æ“ä½œæŒ‰éˆ• */}
				<header className="py-6 border-b border-gray-200">
				  <div className="flex items-start justify-between gap-4">
					{/* å·¦é‚Šï¼šæ¨™é¡Œèˆ‡åŒ¯ç‡è³‡è¨Š */}
					<div className="flex flex-col gap-2 flex-1 min-w-0">
					  <div className="flex items-center gap-3">
						<Pencil className="w-10 h-10 text-primaryColor-700" />

						{isEditingGroupName && !isReadOnly ? (
						  <div className="flex flex-col sm:flex-row sm:items-center gap-2 flex-1">
							<input
							  type="text"
							  value={groupNameInput}
							  onChange={(e) => setGroupNameInput(e.target.value)}
							  onKeyDown={(e) => {
								if (e.key === 'Enter') {
								  e.preventDefault();
								  saveGroupName();
								} else if (e.key === 'Escape') {
								  e.preventDefault();
								  cancelEditGroupName();
								}
							  }}
							  className="w-full border-b border-primaryColor-500 bg-transparent text-2xl sm:text-3xl font-extrabold text-primaryColor-700 focus:outline-none focus:border-primaryColor-700"
							  autoFocus
							  maxLength={40}
							  placeholder="è¼¸å…¥é€™æœ¬åˆ†å¸³è¨˜å¸³ç°¿åç¨±"
							/>

							{/* æŒ‰éˆ•åœ¨æ‰‹æ©Ÿæ™‚æœƒæ›åˆ°ä¸‹ä¸€è¡Œ */}
							<div className="flex gap-2 justify-end sm:justify-start">
							  <button
								type="button"
								onClick={saveGroupName}
								disabled={isLoading || !groupNameInput.trim()}
								className={
								  "px-3 py-1 rounded-lg text-sm font-semibold text-white shadow-md " +
								  ((isLoading || !groupNameInput.trim())
									? "bg-gray-400 cursor-not-allowed"
									: "bg-primaryColor-600 hover:bg-primaryColor-700")
								}
							  >
								å„²å­˜
							  </button>
							  <button
								type="button"
								onClick={cancelEditGroupName}
								className="px-3 py-1 rounded-lg text-sm font-semibold text-gray-600 hover:bg-gray-100"
							  >
								å–æ¶ˆ
							  </button>
							</div>
						  </div>
						) : (
						  // åŸæœ¬çš„é¡¯ç¤ºæ¨¡å¼ä¿æŒä¸è®Š
						  <div className="flex flex-col">
							<h1
							  className={
								"text-3xl sm:text-4xl font-extrabold text-primaryColor-700 " +
								(isReadOnly ? "" : "cursor-text hover:underline decoration-dotted")
							  }
							  onClick={() => {
								if (!isReadOnly) {
								  startEditGroupName();
								}
							  }}
							  title={isReadOnly ? "" : "é»æ“Šä»¥ä¿®æ”¹é€™æœ¬åˆ†å¸³è¨˜å¸³ç°¿åç¨±"}
							>
							  {groupName || 'åˆ†å¸³è¨˜å¸³ç°¿'}
							</h1>
						  </div>
						)}
					  </div>

					  {lastExchangeUpdate && (
						<p className="text-xs text-gray-500">
						  åŒ¯ç‡æœ€å¾Œæ›´æ–°ï¼š{new Date(lastExchangeUpdate).toLocaleString('zh-TW')}
						</p>
					  )}
					  <p className="text-xs text-gray-500">
						é è¨­å¹£åˆ¥ï¼š{defaultCurrency}ï¼ˆä¾è£ç½® GPS æ¨æ¸¬ï¼‰
					  </p>
					</div>

					{/* å³ä¸Šè§’ï¼šç™»å‡º / è¿”å›è‡ªå·±çš„è¨˜å¸³ç°¿ */}
					<div className="flex flex-col items-end gap-1">
					  {isViewingOwn ? (
						<button
						  onClick={logout}
						  className="mt-1 inline-flex items-center px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold text-red-600 border border-red-300 hover:bg-red-50 transition"
						  title="ç™»å‡º"
						>
						  <LogOut className="w-4 h-4 mr-1" />
						  <span className="inline">ç™»å‡º</span>
						</button>
					  ) : (
						<button
						  onClick={handleReturnToOwn}
						  className="mt-1 inline-flex items-center px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold text-primaryColor-700 border border-primaryColor-300 hover:bg-primaryColor-50 transition"
						>
						  è¿”å›è‡ªå·±çš„è¨˜å¸³ç°¿
						</button>
						)}

					    {/* åˆ†äº«æŒ‰éˆ•ï¼šç§»åˆ°ç™»å‡ºä¸‹é¢ */}
					    <button
						  type="button"
						  onClick={handleCopyShareLink}
						  className="mt-1 inline-flex items-center px-3 py-1.5 rounded-lg text-[11px] sm:text-xs font-semibold text-primaryColor-700 border border-primaryColor-400 bg-white hover:bg-primaryColor-50 transition"
						  title="ç”Ÿæˆä¸¦è¤‡è£½é€™æœ¬è¨˜å¸³ç°¿çš„åˆ†äº«é€£çµ"
					    >
						  <Share2 className="w-4 h-4 mr-1" />
						  é»æ“Šè¤‡è£½é€£çµ
					    </button>
					</div>
				  </div>
				</header>
                
				{/* âœ¨ MODIFIED: é ‚éƒ¨åŒ¯ç‡æ›ç®—å™¨ - æ”¾åœ¨ header ä¹‹å¾Œï¼ŒåŠŸèƒ½æŒ‰éˆ•ä¹‹å‰ */}
				<div className="mt-4 p-4 bg-white rounded-xl shadow-lg border-b border-primaryColor-100 flex flex-wrap items-center justify-between gap-x-3 gap-y-2">
					
					{/* 1. æ¨™ç±¤èˆ‡è¼¸å…¥çµ„ */}
					<div className="flex items-center gap-2 flex-grow min-w-0"> 
						<span className="font-semibold text-gray-700 flex-shrink-0 text-sm"></span>
						{/* ä¾†æºå¹£åˆ¥é¸æ“‡æ¡† (å·¦é‚Š) */}
						<select
							value={converterSourceCurrency}
							onChange={(e) => setConverterSourceCurrency(e.target.value)}
							className="block flex-shrink-0 w-auto border border-gray-300 rounded-lg shadow-sm p-2 text-sm focus:ring-primaryColor-500 focus:border-primaryColor-500 bg-white"
						>
							{CURRENCIES.map(code => (
								<option key={`source-${code}`} value={code}>{code}</option>
							))}
						</select>
						{/* é‡‘é¡è¼¸å…¥æ¡† - ä¿æŒå¯¬åº¦é™åˆ¶ä¸¦ç§»é™¤ w-full */}
						<input
							type="number"
							value={converterAmount}
							onChange={(e) => setConverterAmount(e.target.value)}
							placeholder="é‡‘é¡"
							// âœ¨ æ›´æ”¹: w-auto max-w-[100px] ç¢ºä¿ä¸æœƒä½”æ»¿å‰©é¤˜ç©ºé–“
							className="block w-auto max-w-[100px] border border-gray-300 rounded-lg shadow-sm p-2 text-sm focus:ring-primaryColor-500 focus:border-primaryColor-500"
						/>
					</div>
					
					{/* 2. è¼¸å‡ºçµæœ - ç¢ºä¿åœ¨æœ€å³é‚Šï¼Œä¸¦åœ¨ç©ºé–“ä¸è¶³æ™‚æ›è¡Œ */}
					<div className="flex items-center space-x-1 flex-shrink-0 ml-auto sm:ml-0">
						<span className="text-gray-500 text-sm"></span>
						{/* ç›®æ¨™å¹£åˆ¥é¸æ“‡æ¡† (å³é‚Š) */}
						<select
							value={converterTargetCurrency}
							onChange={(e) => setConverterTargetCurrency(e.target.value)}
							className="block flex-shrink-0 w-auto border border-gray-300 rounded-lg shadow-sm p-2 text-sm focus:ring-primaryColor-500 focus:border-primaryColor-500 bg-white font-bold"
						>
							{CURRENCIES.map(code => (
								<option key={`target-${code}`} value={code}>{code}</option>
							))}
						</select>
						<span className="text-xl font-bold text-primaryColor-600">
							{convertedAmount.toLocaleString('zh-TW')}
						</span>
					</div>
				</div>

                {/* éŒ¯èª¤è¨Šæ¯æç¤º (Appå±¤ç´š) */}
                {error && (
                    <div className="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                        <p className="font-semibold">éŒ¯èª¤æç¤º:</p>
                        <p className="text-sm">{error}</p>
                    </div>
                )}
                
                {/* NEW: è¤‡è£½é€£çµæˆåŠŸæˆ–å¤±æ•—çš„è¨Šæ¯æç¤º (Toast æ•ˆæœ) - ä¿æŒå…¨åŸŸï¼Œç”¨æ–¼ç™»å…¥/ç™»å‡º/è¤‡è£½ */}
                {copyMessage && (
                    <div className="fixed top-4 left-1/2 transform -translate-x-1/2 p-3 bg-primaryColor-600 text-white rounded-lg shadow-xl z-50 transition-opacity duration-300">
                        <p className="font-semibold text-sm">{copyMessage}</p>
                    </div>
                )}
                
				
                {/* ä¸»è¦åŠŸèƒ½å€å¡Š */}
                <div className="mt-6 flex space-x-4">
                  <button
                    onClick={startAdd}
                    disabled={isReadOnly}
                    className={
                      "flex-1 flex items-center justify-center px-4 py-3 rounded-xl text-white transition duration-300 shadow-xl hover:scale-[1.03] transform disabled:bg-gray-400 disabled:cursor-not-allowed " +
                      (isReadOnly ? "bg-gray-400" : "bg-primaryColor-500 hover:bg-primaryColor-600 focus:ring-4 focus:ring-primaryColor-300")
                    }
                  >
                    <Plus className="w-6 h-6 mr-2" />
                    æ–°å¢æ”¯å‡º {isReadOnly && '(å”¯è®€)'}
                  </button>
                  <button
                    onClick={() => { setIsMemberModalOpen(true); setError(null); }}
                    disabled={isReadOnly}
                    className={
                      "px-4 py-3 border text-lg font-bold rounded-xl bg-white focus:outline-none focus:ring-4 transition duration-300 shadow-xl hover:scale-[1.03] transform disabled:border-gray-400 disabled:text-gray-400 disabled:cursor-not-allowed " +
                      (isReadOnly
                        ? "border-gray-400 text-gray-400"
                        : "focus:ring-primaryColor-300 border-primaryColor-500 text-primaryColor-600 hover:bg-primaryColor-50")
                    }
                    aria-label="ç®¡ç†æˆå“¡èˆ‡é è¨­ä»½æ•¸"
                  >
                    <Users className="w-6 h-6" />
                  </button>
                </div>

                {/* ç¸½çµèˆ‡åˆ—è¡¨ */}
                <BalanceSummary 
                    settlements={calculateSettlements} 
                    balances={calculateBalances} 
                    members={members} 
                    getDisplayName={getDisplayName} 
                    isReadOnly={isReadOnly}
                    settleMemberDebt={settleMemberDebt}
                />
                <ExpenseList 
                    expenses={expenses} 
                    deleteExpense={deleteExpense} 
                    startEdit={startEdit} 
                    isLoading={isLoading} 
                    getDisplayName={getDisplayName} 
                    formatTimestamp={formatTimestamp}
                    isReadOnly={isReadOnly}
                    clearAllExpenses={clearAllExpenses}
                    // âœ¨ æ–°å¢æœå°‹ç›¸é—œ props
                    searchKeyword={searchKeyword}
                    setSearchKeyword={setSearchKeyword}
                />

                {/* Modal å€å¡Š */}
                <ExpenseModal 
                    key={expenseModalState.isEditing && expenseModalState.editingExpense ? `edit-${expenseModalState.editingExpense.id}` : 'add-new'}
                    db={db}
                    currentUserId={userId}
                    members={members}
                    getInitialShares={getInitialShares}
                    state={expenseModalState}
                    onClose={closeExpenseModal}
                    getDisplayName={getDisplayName} 
                    isReadOnly={isReadOnly}
                    collectionId={currentCollectionId}
                    liveExchangeRates={liveExchangeRates}
					defaultCurrency={defaultCurrency}
					currentUserLabel={currentUserLabel}
                />
                <MemberManagementModal 
                    db={db}
                    currentUserId={userId}
                    members={members}
                    customMembers={customMembers}
                    defaultSharesConfig={defaultSharesConfig}
                    isMemberModalOpen={isMemberModalOpen}
                    setIsMemberModalOpen={setIsMemberModalOpen}
                    saveMembers={saveMembers}
                    handleSaveDefaultShares={handleSaveDefaultShares}
                    handleDeleteMember={handleDeleteMember}
                    setIsLoading={setIsLoading}
                    isLoading={isLoading}
                    setError={setError}
                    getDisplayName={getDisplayName}
                    isReadOnly={isReadOnly}
					inviteEmail={inviteEmail}
					setInviteEmail={setInviteEmail}
					groupMembers={groupMembers}
					groupOwner={groupOwner}
					inviteUserByEmail={inviteUserByEmail}
					removeGroupMember={removeGroupMember}
                    setToastMessage={setToastMessage}
                />
                
                {/* çµ±ä¸€çš„ç¢ºèªæç¤º Modal */}
                <ConfirmationModal 
                    isOpen={confirmModalState.isOpen}
                    onClose={closeConfirmModal}
                    onConfirm={confirmModalState.onConfirm}
                    title={confirmModalState.title}
                    message={confirmModalState.message}
                    confirmText={confirmModalState.confirmText}
                    confirmColor={confirmModalState.confirmColor}
                />
              </div>

              {/* Tailwind color class fix, è®“ primaryColor é¡åˆ¥ä¸€å®šå‡ºç¾åœ¨æª”æ¡ˆä¸­ */}
              <div className="text-primaryColor-500 bg-primaryColor-500 border-primaryColor-500 hidden"></div>
            </div>
          );
        };
        
        // --- ç¨ç«‹çš„åˆ—è¡¨å’Œç¸½çµçµ„ä»¶ ---
        const ExpenseList = React.memo(({ expenses, deleteExpense, startEdit, isLoading, getDisplayName, formatTimestamp, isReadOnly, clearAllExpenses, searchKeyword, setSearchKeyword }) => { // âœ¨ æ¥å—æœå°‹ç›¸é—œ props
            const sortedExpenses = useMemo(() => {
                // 1. Sort by timestamp
                const sorted = [...expenses].sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.getTime() : 0;
                    const timeB = b.timestamp ? b.timestamp.getTime() : 0;
                    return timeB - timeA;
                });
                
                // 2. Filter by searchKeyword (case-insensitive on description)
                if (!searchKeyword.trim()) {
                    return sorted;
                }
                
                const lowerCaseKeyword = searchKeyword.toLowerCase();
                
                return sorted.filter(exp => 
                    (exp.description || '').toLowerCase().includes(lowerCaseKeyword)
                );
                
            }, [expenses, searchKeyword]); // âœ¨ ä¾è³´ searchKeyword
              
            return (
              <div className="mt-8">
                {/* 1. æ”¯å‡ºåˆ—è¡¨æ¨™é¡Œèˆ‡æ¸…é™¤æŒ‰éˆ• - ä¿æŒåœ¨åŒä¸€è¡Œ */}
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                    <CircleDollarSign className="w-7 h-7 mr-3 text-primaryColor-500" /> 
                    æ‰€æœ‰æ”¯å‡º ({expenses.length})
                  </h2>
                  
                  {/* æ¸…é™¤æ‰€æœ‰è³‡æ–™æŒ‰éˆ• */}
                  <button
                      onClick={clearAllExpenses}
                      disabled={isLoading || isReadOnly || expenses.length === 0}
                      className="px-3 py-1.5 text-sm rounded-lg text-white bg-red-500 hover:bg-red-600 transition hover:scale-105 transform shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center flex-shrink-0"
                  >
                      <Trash2 className="w-4 h-4 mr-1" />
                      æ¸…é™¤æ‰€æœ‰è³‡æ–™
                  </button>
                </div>
                
                {/* âœ¨ NEW: æœå°‹æ¬„ä½ - ç¨ç«‹å‡ºä¾†ï¼Œåœ¨æ¨™é¡Œä¸‹æ–¹ï¼Œæ¸…å–®ä¸Šæ–¹ */}
                <div className="mb-4">
                    <div className="relative">
                      <input
                        type="text"
                        value={searchKeyword}
                        onChange={(e) => setSearchKeyword(e.target.value)}
                        placeholder="è¼¸å…¥å“é …/æè¿°é€²è¡Œæœå°‹..." 
                        // è®“å®ƒä¿æŒå…¨å¯¬
                        className="w-full border border-gray-300 rounded-full h-10 py-2 pl-10 pr-4 text-sm focus:ring-primaryColor-500 focus:border-primaryColor-500 transition-all duration-300"
                        aria-label="æœå°‹æ”¯å‡º"
                      />
                      <Search className="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" />
                    </div>
                </div>
                
                {/* é¡¯ç¤ºæœå°‹çµæœæ•¸é‡æç¤º */}
                {searchKeyword.trim() !== '' && expenses.length > sortedExpenses.length && (
                    <p className="text-sm text-gray-600 mb-4 italic p-2 bg-gray-100 rounded-lg">
                        ğŸ” é¡¯ç¤º {sortedExpenses.length} ç­†ç¬¦åˆã€Œ{searchKeyword}ã€çš„çµæœ (ç¸½è¨ˆ {expenses.length} ç­†)ã€‚
                    </p>
                )}
                
                {sortedExpenses.length === 0 ? (
                  <p className="text-gray-500 italic p-4 bg-white rounded-xl shadow-inner">
                    {searchKeyword.trim() ? `æ‰¾ä¸åˆ°ä»»ä½•ç¬¦åˆã€Œ${searchKeyword}ã€çš„æ”¯å‡ºè¨˜éŒ„ã€‚` : 'ç›®å‰æ²’æœ‰ä»»ä½•æ”¯å‡ºè¨˜éŒ„ã€‚'}
                  </p>
                ) : (
                  <div className="space-y-4">
                    {sortedExpenses.map((exp) => {
                      const totalShares = Object.values(exp.shares).reduce((sum, s) => sum + s, 0);
                      const sharesDetail = Object.entries(exp.shares)
                        .filter(([, share]) => share > 0)
                        .map(([name, share]) => `${getDisplayName(name)} (${share}ä»½)`)
                        .join(', ');

                      const displayAmount = `${exp.currency} ${Math.round(exp.originalAmount).toFixed(0)}`;
                      const convertedTWD = exp.currency !== DEFAULT_CURRENCY ? ` (TWD ${exp.amountInTWD.toFixed(0)})` : '';

                      return (
                        <div key={exp.id} className="bg-white p-4 rounded-xl shadow-lg border-l-4 border-primaryColor-400 flex justify-between items-center transition duration-150 hover:shadow-xl">
                          <div className="flex-grow">
                            <p className="font-semibold text-lg text-gray-800">{exp.description}</p>
                            <p className="text-3xl font-extrabold text-primaryColor-600 my-1">
                                {displayAmount}
                                <span className="text-xl font-normal text-gray-500">{convertedTWD}</span>
                            </p> 
                            <p className="text-sm text-gray-600">
                              <span className="font-medium text-primaryColor-700">ä»˜æ¬¾äºº:</span> {getDisplayName(exp.payerName)}
                            </p>
                            <p className="text-xs text-gray-500 mt-1">
                              <span className="font-medium">åˆ†å¸³:</span> {sharesDetail || 'ç„¡äººåˆ†å¸³'} (ç¸½ä»½æ•¸: {totalShares})
                            </p>
                            <p className="text-xs text-gray-400 mt-1">
                              <span className="font-medium">æ™‚é–“:</span> {formatTimestamp(exp.timestamp)}
                            </p>
                          </div>
                          <div className={`flex space-x-2 ${isReadOnly ? 'opacity-50' : ''}`}>
                            <button
                              onClick={() => startEdit(exp)}
                              className="p-2 text-blue-500 bg-white hover:bg-blue-50 rounded-full transition duration-150 hover:scale-110 transform border border-transparent hover:border-blue-300 shadow-md disabled:cursor-not-allowed"
                              aria-label="ç·¨è¼¯æ”¯å‡º"
                              disabled={isReadOnly}
                            >
                              <Pencil className="w-5 h-5" />
                            </button>
                            <button
                              onClick={() => deleteExpense(exp.id)}
                              disabled={isLoading || isReadOnly}
                              className="p-2 text-red-500 bg-white hover:bg-blue-50 rounded-full transition duration-150 hover:scale-110 transform border border-transparent hover:border-red-300 shadow-md disabled:cursor-not-allowed"
                              aria-label="åˆªé™¤æ”¯å‡º"
                            >
                              <Trash2 className="w-5 h-5" />
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            );
        });

        const BalanceSummary = React.memo(({ settlements, balances, members, getDisplayName, isReadOnly, settleMemberDebt }) => {
            const debtorBalances = useMemo(() => {
                return members.filter(member => Math.round(balances[member] || 0) < 0)
                               .map(member => ({
                                   id: member,
                                   amount: Math.abs(Math.round(balances[member] || 0)),
                                   displayName: getDisplayName(member),
                               }))
                               .filter(d => d.amount > 0);
            }, [balances, members, getDisplayName]);

            return (
              <div className="mt-8 p-6 bg-white rounded-xl shadow-2xl">
                <h2 className="text-2xl font-bold mb-4 text-gray-800 flex items-center">
                  <Users className="w-7 h-7 mr-3 text-primaryColor-500" />
                  çµé¤˜ç¸½çµ 
                </h2>

                {settlements.length === 0 ? (
                    <p className="text-lg font-medium text-green-600 p-3 bg-green-50 rounded-lg">ğŸ‰ æ‰€æœ‰å¸³ç›®å·²çµæ¸…ï¼</p>
                ) : (
                    <div className="space-y-4">
                        <p className="text-base text-gray-600 mb-4">çµæ¸…å¸³ç›®æ‰€éœ€çš„è½‰å¸³æ¸…å–®ï¼ˆå››æ¨äº”å…¥ï¼‰ï¼š</p>
                        {settlements.map((settlement, index) => {
                            const canSettle = !isReadOnly; 

                            return (
                                <div 
                                    key={index} 
                                    className="bg-yellow-50 p-4 rounded-xl shadow-md border-l-4 border-yellow-400 flex justify-between items-center transition duration-150" 
                                >
                                    <div className="flex items-center">
                                        <span className="font-bold text-yellow-800 text-xl mr-3">ğŸ’¸</span>
                                        <div className="text-gray-800">
                                            <p className="text-lg">
                                                <span className="font-bold text-red-600">{getDisplayName(settlement.from)}</span>
                                                <span className="mx-0 text-gray-500">æ‡‰ä»˜çµ¦</span>
                                                <span className="font-bold text-green-600">{getDisplayName(settlement.to)}</span>
                                            </p>
                                            <p className="text-3xl font-extrabold text-yellow-700 mt-1">
                                                TWD {settlement.amount.toFixed(0)}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    {canSettle && (
                                        <button
                                            onClick={() => settleMemberDebt(settlement.from, settlement.amount, settlement.to)} 
                                            className="px-3 py-1 text-sm rounded-lg text-white transition hover:scale-105 transform shadow-md flex items-center bg-green-500 hover:bg-green-600"
                                        >
                                            <CircleCheck className="w-4 h-4 mr-1" />
                                            çµæ¸…
                                        </button>
                                    )}
                                    {isReadOnly && (
                                         <span className="text-sm text-gray-500 italic">åƒ…æ“æœ‰è€…å¯æ“ä½œ</span>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                )}
              </div>
            );
        });
        
        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>