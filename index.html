<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†å¸³è¨˜å¸³ç°¿ (Email ç™»å…¥èˆ‡åˆ†äº«)</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React, ReactDOM, and Babel ç¨ç«‹ç‰ˆ -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* ä¿®æ­£ï¼šç§»é™¤è¼¸å…¥æ¡†åŸç”Ÿçš„å¢æ¸›æ§åˆ¶é … */
        input[type='number'] {
            -moz-appearance: textfield;
        }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
    
    <script>
        // è¨­å®š Tailwind CSS é¡è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primaryColor: {
                            500: '#14b8a6', // teal-500
                            600: '#0d9488', // teal-600
                            700: '#0f766e', // teal-700
                        },
                    },
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- 
        é‡è¦ï¼šè«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„ Firebase é…ç½®ï¼
        æ³¨æ„ï¼šç¾åœ¨éœ€è¦é–‹å•Ÿ Firebase Authentication çš„ Email/Password ç™»å…¥æ–¹æ³•
    -->
    <script>
        // ä¿®æ­£ï¼šå°‡é€™äº›è®Šæ•¸å®šç¾©åœ¨ç´” JS å€å¡Šï¼Œä½¿ Babel è…³æœ¬å¯ä»¥è¨ªå•
        const __app_id = "YOUR_APP_ID"; // ä¾‹å¦‚: 'my-splitwise-app-2025'
        // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé…ç½® JSON
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyANDhJ--MDYI5SfsHOuuQwVM0sYMM91UFM",
            authDomain: "splite-expense-tracker-multi.firebaseapp.com",
            projectId: "splite-expense-tracker-multi",
            storageBucket: "splite-expense-tracker-multi.firebasestorage.app",
            messagingSenderId: "10696910340",
            appId: "1:10696910340:web:2ccda0f7db8ef8af6f3751",
            measurementId: "G-XCB90NSB43"
        });
        const __initial_auth_token = null; // ä¸å†ä½¿ç”¨åŒ¿åç™»å…¥

        // æ–°å¢ï¼šè«‹å°‡æ‚¨çš„ Gemini API Key å¡«å…¥æ­¤è™•
        const GEMINI_API_KEY = ""; 
    </script>

    <!-- 
        ä½¿ç”¨ Firebase v9 ç›¸å®¹æ¨¡å¼ (compat)
    -->
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    
    <script type="text/babel">
        // ä¿®æ­£ 1ï¼šæ˜ç¢ºè²æ˜ React ç‚ºå…¨åŸŸè®Šæ•¸ï¼Œç¢ºä¿ Babel èƒ½å¤ æ‰¾åˆ°å®ƒ
        const React = window.React;

        const { useState, useEffect, useCallback, useMemo } = React;
        
        // ä¿®æ­£ï¼šå°‡å…¨åŸŸè®Šæ•¸å¼•å…¥ Babel ä½œç”¨åŸŸ (ç§»é™¤ GEMINI_API_KEY çš„ const å®£å‘Š)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? initialAuthToken : null;
        
        // æ³¨æ„ï¼šGEMINI_API_KEY å·²åœ¨é ‚å±¤çš„ç´” JS å€å¡Šä¸­å®šç¾©ï¼Œå¯ä»¥ç›´æ¥è¨ªå•
        const { firestore } = firebase;
        const serverTimestamp = firestore.FieldValue.serverTimestamp; 
        
        // --- åŒ¯ç‡è¨­å®š (ä¿®æ­£: é è¨­å€¼ä½œç‚ºå‚™ç”¨) ---
        const DEFAULT_EXCHANGE_RATES = {
            'TWD': 1.0,   // åŸºæº–è²¨å¹£ï¼šè‡ºå¹£
            'USD': 30.5,  // ç¾é‡‘
            'THB': 0.85,  // æ³°éŠ–
            'EUR': 33.0,  // æ­å…ƒ
            'CAD': 22.5,  // åŠ å¹£
            'VND': 0.0013, // è¶Šå—ç›¾ (1000 VND ~ 1.3 TWD)
            'IDR': 0.002, // å°å°¼ç›¾ (1000 IDR ~ 2 TWD)
            'JPY': 0.25,  // æ—¥åœ“
            'KRW': 0.023, // éŸ“å…ƒ (1000 KRW ~ 23 TWD)
            'AUD': 20.0,  // æ¾³å¹£
            'NOK': 2.9,   // æŒªå¨å…‹æœ—
        };
        const CURRENCIES = Object.keys(DEFAULT_EXCHANGE_RATES);
        const DEFAULT_CURRENCY = 'TWD';

        // --- åŒ¯ç‡ç²å–å‡½å¼ï¼šæ¯ 4 å°æ™‚æ›´æ–°ä¸€æ¬¡ + å¯é¡¯ç¤ºæ›´æ–°æ™‚é–“ ---
		const fetchExchangeRates = async () => {
			const CACHE_KEY = "exchangeRatesCache";
			const CACHE_TIME_KEY = "exchangeRatesCacheTime";
			const FOUR_HOURS = 4 * 60 * 60 * 1000;

			// 1. å¾ localStorage è®€å–å¿«å–
			try {
				const cachedRates = localStorage.getItem(CACHE_KEY);
				const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

				if (cachedRates && cachedTime) {
					const lastUpdate = parseInt(cachedTime, 10);
					const now = Date.now();

					// å°‘æ–¼ 4 å°æ™‚ â†’ ä½¿ç”¨å¿«å–
					if (now - lastUpdate < FOUR_HOURS) {
						console.log("ğŸ“¦ ä½¿ç”¨å¿«å–åŒ¯ç‡ï¼ˆ4 å°æ™‚å…§ï¼‰");

						return {
							rates: JSON.parse(cachedRates),
							lastUpdate
						};
					}
				}
			} catch (err) {
				console.warn("âš  è®€å–åŒ¯ç‡å¿«å–å¤±æ•—ï¼Œå°‡é‡æ–°æŠ“å–ã€‚", err);
			}

			// 2. è¶…é 4 å°æ™‚ â†’ æŠ“å–æ–°è³‡æ–™
			const API_URL = "https://open.er-api.com/v6/latest/TWD";

			try {
				const res = await fetch(API_URL);
				if (!res.ok) throw new Error("API å›æ‡‰éŒ¯èª¤");

				const data = await res.json();
				if (!data || data.result !== "success") throw new Error("ç„¡æ•ˆåŒ¯ç‡è³‡æ–™");

				const processedRates = { [DEFAULT_CURRENCY]: 1.0 };

				CURRENCIES.forEach(code => {
					if (code === DEFAULT_CURRENCY) return;

					const rateTWDToCode = data.rates[code]; // 1 TWD = x {code}
					if (typeof rateTWDToCode === "number" && rateTWDToCode > 0) {
						processedRates[code] = 1 / rateTWDToCode; // 1 {code} = ? TWD
					} else {
						processedRates[code] = DEFAULT_EXCHANGE_RATES[code];
					}
				});

				const now = Date.now();

				// 3. å†™å…¥ Cache
				try {
					localStorage.setItem(CACHE_KEY, JSON.stringify(processedRates));
					localStorage.setItem(CACHE_TIME_KEY, now.toString());
				} catch (err) {
					console.warn("âš ï¸ ç„¡æ³•å¯«å…¥å¿«å–ï¼ˆå¯èƒ½æ˜¯ç„¡ç—•æ¨¡å¼ï¼‰", err);
				}

				console.log("ğŸŒ å·²æŠ“å–æœ€æ–°åŒ¯ç‡", processedRates);

				return {
					rates: processedRates,
					lastUpdate: now
				};

			} catch (err) {
				console.error("âŒ æŠ“å–åŒ¯ç‡å¤±æ•—ï¼Œä½¿ç”¨é è¨­åŒ¯ç‡", err);
				const fallbackTime = Date.now();

				return {
					rates: DEFAULT_EXCHANGE_RATES,
					lastUpdate: fallbackTime
				};
			}
		};


        const primaryColor = 'teal';
        
        // --- å…§è¯ SVG åœ–æ¨™å…ƒä»¶ (Lucide æ¨£å¼) ---
        const IconProps = {
            stroke: "currentColor",
            strokeWidth: 2,
            strokeLinecap: "round",
            strokeLinejoin: "round",
            fill: "none", // ç¢ºä¿ SVG åœ–æ¨™æ²’æœ‰å¡«å……ï¼Œåªé¡¯ç¤ºç·šæ¢
        };
        
        const CircleDollarSign = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v1M12 17v1M16 8h-4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2z"></path></svg>;
        const Trash2 = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const Plus = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>;
        const Minus = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M5 12h14"></path></svg>;
        const Users = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;
        const X = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>;
        // ä¿®æ­£ 2: Check æ›¿æ›ç‚º CircleCheck çš„ SVG (åœ“åœˆå‹¾)
        const CircleCheck = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14 9 11"></polyline></svg>;
        const Pencil = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>;
        const UserPlus = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" x2="19" y1="8" y2="14"></line><line x1="16" x2="22" y1="11" y2="11"></line></svg>;
        const UserMinus = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="22" x2="16" y1="11" y2="11"></line></svg>;
        const LogOut = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>;
        const RefreshCw = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.76 2.91L3 8"></path><path d="M3 3v5h5"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.76-2.91L21 16"></path><path d="M21 21v-5h-5"></path></svg>;
        const Share2 = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"></line><line x1="15.42" x2="8.59" y1="6.51" y2="10.49"></line></svg>;
        // --- åœ–æ¨™å…ƒä»¶çµæŸ ---

        /**
         * å‰µå»ºæˆ–æ›´æ–° Firestore å…¬å…± Profile
         */
        const createOrUpdatePublicProfile = async (db, uid, displayName, email) => {
            if (!db || !uid || !displayName) return;
            const profileDocPath = `artifacts/${appId}/public_profiles/${uid}`;
            try {
                await db.doc(profileDocPath).set({ 
                    displayName: displayName,
                    email: email,
                    uid: uid,
                }, { merge: true });
            } catch (e) {
                console.error("Error creating/updating public profile:", e);
            }
        };
        
        /**
         * é€šç”¨ç¢ºèªæç¤º Modal
         */
        const ConfirmationModal = React.memo(({ isOpen, onClose, onConfirm, title, message, confirmText, confirmColor = 'red' }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[9999] transition-opacity">
                    <div className="bg-white rounded-xl w-full max-w-sm shadow-2xl transform transition-transform duration-300 scale-100">
                        <div className="p-6">
                            <h3 className="text-xl font-bold text-gray-800 mb-4">{title}</h3>
                            <p className="text-gray-600 mb-6">{message}</p>
                            <div className="flex justify-end space-x-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 rounded-full text-gray-700 bg-gray-200 hover:bg-gray-300 transition font-semibold"
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    onClick={onConfirm}
                                    className={`px-4 py-2 rounded-full text-white font-semibold transition duration-150 shadow-md bg-${confirmColor}-600 hover:bg-${confirmColor}-700`}
                                >
                                    {confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        });


        /**
         * èªè­‰æ¨¡æ…‹è¦–çª—
         */
        const AuthModal = React.memo(({ auth, db }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [nickname, setNickname] = useState(''); // æ–°å¢æš±ç¨±ç‹€æ…‹
            const [isLogin, setIsLogin] = useState(true);
            const [error, setError] = useState(null);
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(null);
                setIsLoading(true);

                if (!email || !password || (!isLogin && !nickname)) {
                    setError('è«‹è¼¸å…¥æ‰€æœ‰å¿…å¡«æ¬„ä½ã€‚');
                    setIsLoading(false);
                    return;
                }

                try {
                    let userCredential;
                    let finalDisplayName = nickname.trim();

                    if (isLogin) {
                        userCredential = await auth.signInWithEmailAndPassword(email, password);
                        
                        // ç™»å…¥å¾Œï¼Œå¦‚æœ Auth Profile æœ‰æš±ç¨±ï¼Œå°±ä½¿ç”¨å®ƒï¼›å¦å‰‡ä½¿ç”¨ Email
                        finalDisplayName = userCredential.user.displayName || email;
                        
                    } else {
                        userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        
                        // è¨»å†ŠæˆåŠŸå¾Œæ›´æ–° displayName (Auth Profile)
                        await userCredential.user.updateProfile({
                            displayName: finalDisplayName
                        });
                    }
                    
                    // ç„¡è«–æ˜¯ç™»å…¥é‚„æ˜¯è¨»å†Šï¼Œéƒ½ç¢ºä¿ Firestore å…¬å…± Profile å­˜åœ¨
                    if (db) {
                        await createOrUpdatePublicProfile(db, userCredential.user.uid, finalDisplayName, email);
                    }

                } catch (e) {
                    console.error("Auth error:", e.code, e.message);
                    let displayError = e.message;
                    if (e.code === 'auth/email-already-in-use') {
                        displayError = 'è©²é›»å­éƒµä»¶å·²è¢«è¨»å†Šï¼Œè«‹ç›´æ¥ç™»å…¥æˆ–ä½¿ç”¨ä¸åŒéƒµä»¶ã€‚';
                    } else if (e.code === 'auth/invalid-email') {
                        displayError = 'ç„¡æ•ˆçš„é›»å­éƒµä»¶æ ¼å¼ã€‚';
                    } else if (e.code === 'auth/wrong-password' || e.code === 'auth/user-not-found') {
                        displayError = 'é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚';
                    } else if (e.code === 'auth/weak-password') {
                        displayError = 'å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹ä½¿ç”¨è‡³å°‘ 6 å€‹å­—å…ƒã€‚';
                    }
                    setError(displayError);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl w-full max-w-md shadow-2xl p-6 sm:p-8">
                        <h3 className={`text-3xl font-bold text-${primaryColor}-600 text-center mb-6`}>
                            {isLogin ? 'ç™»å…¥ç´€éŒ„ç°¿' : 'è¨»å†Šæ–°å¸³è™Ÿ'}
                        </h3>
                        {error && <p className="text-red-600 bg-red-100 p-3 rounded-lg text-sm mb-4">{error}</p>}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {/* è¨»å†Šæ™‚é¡¯ç¤ºæš±ç¨±è¼¸å…¥æ¡† */}
                            {!isLogin && (
                                <div>
                                    <label htmlFor="nickname" className="block text-sm font-medium text-gray-700">æš±ç¨± (é¡¯ç¤ºåç¨±)</label>
                                    <input
                                        type="text"
                                        id="nickname"
                                        value={nickname}
                                        onChange={(e) => setNickname(e.target.value)}
                                        placeholder="è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±"
                                        className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                                        disabled={isLoading}
                                        required={!isLogin}
                                    />
                                </div>
                            )}

                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶</label>
                                <input
                                    type="email"
                                    id="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder="your.email@example.com"
                                    className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                                    disabled={isLoading}
                                />
                            </div>
                            <div>
                                <label htmlFor="password" className="block text-sm font-medium text-gray-700">å¯†ç¢¼ (è‡³å°‘ 6 ä½)</label>
                                <input
                                    type="password"
                                    id="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="******"
                                    className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                                    disabled={isLoading}
                                    minLength="6"
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={isLoading}
                                className={`w-full flex items-center justify-center px-4 py-3 rounded-full text-white font-semibold transition duration-300 shadow-lg ${
                                    isLoading ? 'bg-gray-400 cursor-not-allowed' : `bg-${primaryColor}-600 hover:bg-${primaryColor}-700`
                                }`}
                            >
                                {isLoading ? 'è™•ç†ä¸­...' : (isLogin ? 'ç™»å…¥' : 'è¨»å†Š')}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <button
                                onClick={() => { setIsLogin(prev => !prev); setError(null); setNickname(''); }} // æ¸…é™¤æš±ç¨±ç‹€æ…‹
                                className={`text-${primaryColor}-600 hover:text-${primaryColor}-800 font-medium text-sm`}
                            >
                                {isLogin ? 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š' : 'å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿé»æ­¤ç™»å…¥'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        });
        
        /**
         * ç´€éŒ„ç°¿å…±äº«èˆ‡åˆ‡æ›å…ƒä»¶
         */
        const CollectionSwitch = React.memo(({ userId, currentCollectionId, setCurrentCollectionId, getDisplayName, logout, userProfiles }) => {
            const [newId, setNewId] = useState('');
            const [isEditing, setIsEditing] = useState(false);
            const [error, setError] = useState(null);
            const [copyMessage, setCopyMessage] = useState('');

            const handleSwitch = () => {
                setError(null);
                const trimmedId = newId.trim();
                // æª¢æŸ¥ UID æ ¼å¼æ˜¯å¦ç‚º 28 å€‹å­—å…ƒé•·åº¦ (Firebase æ¨™æº– UID é•·åº¦)
                if (trimmedId && trimmedId !== currentCollectionId && trimmedId.length === 28) {
                    setCurrentCollectionId(trimmedId);
                    setIsEditing(false);
                    setNewId('');
                } else if (trimmedId === currentCollectionId) {
                    setError("æ‚¨å·²ç¶“åœ¨æŸ¥çœ‹æ­¤ç´€éŒ„ç°¿äº†ã€‚");
                } else {
                    setError("è¼¸å…¥çš„ ID æ ¼å¼ç„¡æ•ˆæˆ–é•·åº¦ä¸ç¬¦ (éœ€ç‚º 28 å­—å…ƒçš„ UID)ã€‚");
                }
            };
            
            const handleBackToOwn = () => {
                if (userId && currentCollectionId !== userId) {
                    setCurrentCollectionId(userId);
                    setCopyMessage('å·²åˆ‡æ›å›æ‚¨çš„ç§æœ‰ç´€éŒ„ç°¿ã€‚');
                    setTimeout(() => setCopyMessage(''), 4000);
                }
            };

            // æ–°å¢: è¤‡è£½åˆ†äº«é€£çµåŠŸèƒ½
            const handleCopyLink = () => {
                if (!userId) return;

                // æ§‹å»ºå¸¶æœ‰ç•¶å‰ç´€éŒ„ç°¿ ID çš„ URL åƒæ•¸
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${baseUrl}?shareId=${currentCollectionId}`;
                
                // ä½¿ç”¨ document.execCommand('copy') ä¾†ä¿è­‰åœ¨ iFrame ç’°å¢ƒä¸­ä¹Ÿèƒ½è¤‡è£½
                const tempInput = document.createElement('textarea');
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                
                try {
                    document.execCommand('copy');
                    setCopyMessage('âœ¨ é€£çµå·²è¤‡è£½ï¼');
                } catch (err) {
                    console.error('ç„¡æ³•è¤‡è£½é€£çµ', err);
                    setCopyMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ç¶²å€ã€‚');
                }
                
                document.body.removeChild(tempInput);
                
                setTimeout(() => setCopyMessage(''), 4000);
            };
            
            const isViewingOwn = currentCollectionId === userId;
            
            // ä¿®æ­£ 5: é¡¯ç¤ºåç¨±é‚è¼¯ç°¡åŒ–
            let collectionDisplay = currentCollectionId;
            if (userProfiles[currentCollectionId]) {
                collectionDisplay = userProfiles[currentCollectionId];
            } else if (currentCollectionId === userId) {
                collectionDisplay = getDisplayName(userId);
            } else {
                // å¦‚æœæ˜¯å…¶ä»–äººçš„ï¼Œä½†æ‰¾ä¸åˆ°æš±ç¨±ï¼Œå‰‡é¡¯ç¤º UID çš„ç°¡çŸ­å½¢å¼
                collectionDisplay = `${currentCollectionId.substring(0, 5)}...${currentCollectionId.substring(currentCollectionId.length - 5)}`;
            }
            
            return (
                <div className="p-4 bg-primaryColor-50 rounded-xl shadow-inner border border-primaryColor-200 mt-4">
                    {copyMessage && <p className={`mb-3 p-2 text-sm rounded-lg text-green-700 bg-green-100 transition-opacity duration-500`}>{copyMessage}</p>}
                    <div className="flex justify-between items-start mb-2">
                        <div>
                            <p className="text-sm font-semibold text-gray-700">ç•¶å‰ç´€éŒ„ç°¿æ“æœ‰è€…:</p>
                            <p className="font-extrabold text-lg text-primaryColor-700 truncate" title={currentCollectionId}>
                                {/* ä¿®æ­£ï¼šé¡¯ç¤ºæš±ç¨±/ç°¡çŸ­IDï¼Œå¦‚æœæ˜¯å…±äº«æ¨¡å¼ï¼ŒåŠ ä¸Š (å…±äº«ä¸­) æ¨™è¨˜ */}
                                {collectionDisplay} {!isViewingOwn && <span className="text-sm font-normal">(å…±äº«ä¸­)</span>}
                            </p>
                        </div>
                        <button 
                            onClick={logout}
                            className="p-2 text-red-600 hover:bg-red-100 rounded-full transition duration-150 transform hover:scale-110 ml-4"
                            title="ç™»å‡º"
                        >
                            <LogOut className="w-6 h-6" />
                        </button>
                    </div>

                    <div className="mt-3 pt-3 border-t border-primaryColor-100 space-y-3">
                        <div className="flex space-x-2">
                            {/* æ–°å¢: åˆ†äº«é€£çµæŒ‰éˆ• */}
                            <button 
                                onClick={handleCopyLink}
                                className={`flex-1 flex items-center justify-center py-2 px-4 border border-primaryColor-600 text-sm font-bold rounded-lg text-white bg-primaryColor-500 hover:bg-primaryColor-600 transition hover:scale-[1.01] transform`}
                                title="ç”Ÿæˆä¸¦è¤‡è£½å¯åˆ†äº«çš„é€£çµ"
                            >
                                <Share2 className="w-5 h-5 mr-2" />
                                è¤‡è£½åˆ†äº«é€£çµ
                            </button>                    
                        </div>
                    </div>
                </div>
            );
        });

        /**
         * æ”¯å‡º Modal (æ ¸å¿ƒé‚è¼¯ç¨ç«‹)
         */
        const ExpenseModal = React.memo(({ db, currentUserId, members, getInitialShares, state, onClose, getDisplayName, isReadOnly, collectionId, liveExchangeRates }) => {
            const [newExpense, setNewExpense] = useState({
                description: '',
                originalAmount: '', // ä¿®æ­£: åŸå§‹é‡‘é¡
                currency: DEFAULT_CURRENCY, // ä¿®æ­£: æ–°å¢å¹£åˆ¥
                payerName: currentUserId || '',
                shares: {}, 
            });
            const [isLoadingModal, setIsLoadingModal] = useState(false);
            const [modalError, setModalError] = useState(null);

            const isEditing = state.isEditing;
            const expenseToEdit = state.editingExpense;
            const modalTitle = isEditing ? 'ç·¨è¼¯æ”¯å‡ºè¨˜éŒ„' : 'æ–°å¢æ”¯å‡ºè¨˜éŒ„';
            const submitText = isEditing ? 'å„²å­˜ä¿®æ”¹' : 'ç¢ºèªæ–°å¢æ”¯å‡º';
            
            // è¨ˆç®—æ›ç®—å¾Œçš„è‡ºå¹£é‡‘é¡
            // ä¿®æ­£: å„ªå…ˆä½¿ç”¨ liveExchangeRatesï¼Œå¦‚æœä¸å­˜åœ¨å‰‡ä½¿ç”¨é è¨­å€¼
            const currentExchangeRate = liveExchangeRates[newExpense.currency] || DEFAULT_EXCHANGE_RATES[newExpense.currency] || 1.0;
            const amountInTWD = useMemo(() => {
                const amount = parseFloat(newExpense.originalAmount) || 0;
                return Math.round(amount * currentExchangeRate);
            }, [newExpense.originalAmount, currentExchangeRate]);


            useEffect(() => {
                if (state.isOpen) {
                    if (isEditing && expenseToEdit) {
                        const initialShares = members.reduce((acc, name) => ({ 
                            ...acc, 
                            [name]: expenseToEdit.shares[name] !== undefined ? expenseToEdit.shares[name] : 0 
                        }), {});
                        setNewExpense({
                            description: expenseToEdit.description,
                            originalAmount: expenseToEdit.originalAmount, // ä¿®æ­£: ä½¿ç”¨åŸå§‹é‡‘é¡
                            currency: expenseToEdit.currency || DEFAULT_CURRENCY, // ä¿®æ­£: ä½¿ç”¨å„²å­˜çš„å¹£åˆ¥
                            payerName: expenseToEdit.payerName,
                            shares: initialShares,
                        });
                    } else {
                        setNewExpense({
                            description: '',
                            originalAmount: '', // ä¿®æ­£: åŸå§‹é‡‘é¡
                            currency: DEFAULT_CURRENCY, // ä¿®æ­£: é è¨­å¹£åˆ¥
                            payerName: currentUserId || members[0] || '',
                            shares: getInitialShares(),
                        });
                    }
                    setModalError(null);
                }
            }, [state.isOpen, isEditing, expenseToEdit, members, currentUserId, getInitialShares]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setNewExpense(prev => ({
                    ...prev,
                    [name]: name === 'originalAmount' ? parseFloat(value) || '' : value, // ä¿®æ­£: ç›£è½åŸå§‹é‡‘é¡
                }));
            };

            const handleCurrencyChange = (e) => {
                 setNewExpense(prev => ({
                    ...prev,
                    currency: e.target.value,
                }));
            };

            const handleShareChange = (name, delta) => {
                setNewExpense(prev => {
                    const currentShares = prev.shares[name] || 0;
                    const newShares = Math.max(0, currentShares + delta);
                    return {
                        ...prev,
                        shares: {
                            ...prev.shares,
                            [name]: newShares,
                        },
                    };
                });
            };

            const setToAverageSplit = () => {
                const averageShares = members.reduce((acc, name) => ({ ...acc, [name]: 1 }), {});
                setNewExpense(prev => ({
                    ...prev,
                    shares: averageShares,
                }));
            };

            const saveExpense = async () => {
                if (isReadOnly) {
                    setModalError('æ‚¨æ­£åœ¨ç€è¦½å…±äº«ç´€éŒ„ç°¿ï¼Œç„¡æ³•é€²è¡Œä¿®æ”¹ã€‚è«‹åˆ‡æ›å›æ‚¨çš„ç§æœ‰ç´€éŒ„ç°¿ã€‚');
                    return;
                }
                if (!db || !currentUserId) return;

                if (!newExpense.description.trim() || newExpense.originalAmount <= 0 || !newExpense.payerName) {
                    setModalError('è«‹è¼¸å…¥æœ‰æ•ˆçš„å“é …ã€é‡‘é¡å’Œä»˜æ¬¾äººï¼');
                    return;
                }

                setIsLoadingModal(true);
                setModalError(null);
                try {
                    const expenseToSave = {
                        description: newExpense.description,
                        originalAmount: newExpense.originalAmount, // ä¿®æ­£: åŸå§‹é‡‘é¡
                        currency: newExpense.currency, // ä¿®æ­£: åŸå§‹å¹£åˆ¥
                        exchangeRate: currentExchangeRate, // ä¿®æ­£: å„²å­˜åŒ¯ç‡
                        amountInTWD: amountInTWD, // ä¿®æ­£: å„²å­˜è‡ºå¹£æ›ç®—å¾Œçš„é‡‘é¡ (ç”¨æ–¼è¨ˆç®—)
                        payerName: newExpense.payerName,
                        shares: Object.entries(newExpense.shares).reduce((acc, [name, share]) => {
                            if (share > 0) acc[name] = share;
                            return acc;
                        }, {}),
                        // ä¿®æ­£ï¼šå°‡ creatorId è¨­å®šç‚ºç•¶å‰ç™»å…¥çš„ userIdï¼Œå³ä½¿æ˜¯åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ä¹Ÿä¿ç•™
                        ...(isEditing ? {} : { timestamp: serverTimestamp(), creatorId: currentUserId }),
                        appId: appId,
                    };

                    // ä¿®æ­£: è³‡æ–™è·¯å¾‘ä½¿ç”¨ collectionId
                    const collectionPath = `artifacts/${appId}/users/${collectionId}/expenses`; // <-- ä¿®æ­£è·¯å¾‘
                    
                    if (isEditing) {
                        const docPath = `${collectionPath}/${expenseToEdit.id}`;
                        await db.doc(docPath).update(expenseToSave);
                    } else {
                        await db.collection(collectionPath).add(expenseToSave);
                    }

                    onClose();
                } catch (e) {
                    console.error("Error saving document: ", e);
                    setModalError(`å„²å­˜æ”¯å‡ºå¤±æ•—: ${e.message}`);
                } finally {
                    setIsLoadingModal(false);
                }
            };
            
            if (!state.isOpen) return null;


            return (
              <div 
                key={isEditing ? expenseToEdit.id : 'add-new'} 
                className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity"
              >
                <div className="bg-white rounded-xl w-full max-w-lg shadow-2xl transform transition-transform duration-300 scale-100">
                  <div className="p-6 border-b flex justify-between items-center">
                    <h3 className="text-xl font-bold text-gray-800">{modalTitle} {isReadOnly && <span className="text-red-500 ml-2">(å”¯è®€)</span>}</h3>
                    <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-100 text-gray-600 transition hover:scale-110 transform">
                      <X className="w-6 h-6" />
                    </button>
                  </div>

                  <div className="p-6 space-y-5">
                    {modalError && <p className="text-red-600 bg-red-100 p-3 rounded-lg text-sm">{modalError}</p>}
                    
                    {/* 1. å“é …èˆ‡é‡‘é¡ */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label htmlFor="description" className="block text-sm font-medium text-gray-700">å“é …/æè¿°</label>
                        <input
                          key="expense-description" 
                          type="text"
                          id="description"
                          name="description"
                          value={newExpense.description}
                          onChange={handleInputChange}
                          placeholder="ä¾‹å¦‚: æ™šé¤ï¼Œé›»å½±ç¥¨"
                          className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                          disabled={isReadOnly}
                        />
                      </div>
                      
                      {/* å¹£åˆ¥é¸æ“‡èˆ‡é‡‘é¡è¼¸å…¥ */}
                      <div>
                        <label htmlFor="originalAmount" className="block text-sm font-medium text-gray-700">åŸå§‹é‡‘é¡</label>
                        <div className="flex space-x-2 mt-1">
                          <select
                              id="currency"
                              name="currency"
                              value={newExpense.currency}
                              onChange={handleCurrencyChange}
                              className="block flex-shrink-0 w-auto border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500 bg-white disabled:bg-gray-100"
                              disabled={isReadOnly}
                          >
                            {CURRENCIES.map(code => (
                                <option key={code} value={code}>{code}</option>
                            ))}
                          </select>
                          <input
                            key="expense-amount" 
                            type="number"
                            id="originalAmount"
                            name="originalAmount"
                            value={newExpense.originalAmount}
                            onChange={handleInputChange}
                            placeholder="100.00"
                            className="block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                            disabled={isReadOnly}
                          />
                        </div>
                        
                        {/* é¡¯ç¤ºæ›ç®—å¾Œçš„å°å¹£é‡‘é¡ */}
                        {newExpense.originalAmount > 0 && newExpense.currency !== DEFAULT_CURRENCY && (
                           <p className="mt-1 text-xs text-gray-500 italic">
                               æ›ç®—å°å¹£ (TWD) ç´„: 
                               <span className="font-semibold text-primaryColor-600 ml-1">TWD {amountInTWD.toFixed(0)}</span>
                               (åŒ¯ç‡: {currentExchangeRate})
                           </p>
                        )}
                        {newExpense.originalAmount > 0 && newExpense.currency === DEFAULT_CURRENCY && (
                           <p className="mt-1 text-xs text-gray-500 italic">
                               åˆ†å¸³è¨ˆç®—ä½¿ç”¨æ­¤é‡‘é¡ (TWD)
                           </p>
                        )}
                      </div>
                    </div>

                    {/* 2. ä»˜æ¬¾äºº */}
                    <div>
                      <label htmlFor="payerName" className="block text-sm font-medium text-gray-700">ä»˜æ¬¾äºº</label>
                      <select
                        id="payerName"
                        name="payerName"
                        value={newExpense.payerName}
                        onChange={handleInputChange}
                        className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500 bg-white"
                        disabled={isReadOnly}
                      >
                        {members.map(member => (
                          <option key={member} value={member}>
                            {getDisplayName(member)}
                          </option>
                        ))}
                      </select>
                    </div>

                    {/* 3. åˆ†å¸³ä»½æ•¸è¨­å®š */}
                    <div className="pt-4 border-t border-gray-100">
                      <div className="flex justify-between items-center mb-3">
                        <label className="text-lg font-bold text-gray-700">åˆ†å¸³ä»½æ•¸ (Shares)</label>
                        <button
                          onClick={setToAverageSplit}
                          type="button"
                          className="text-sm text-primaryColor-600 hover:text-primaryColor-800 font-medium disabled:opacity-50"
                          disabled={isReadOnly}
                        >
                          [è¨­ç‚ºå¹³å‡åˆ†é…]
                        </button>
                      </div>
                      <div className="space-y-3 max-h-48 overflow-y-auto pr-2">
                        {members.map(member => {
                          const currentShares = newExpense.shares[member] || 0;
                          const displayMember = getDisplayName(member);
                          const isPayer = newExpense.payerName === member;

                          return (
                            <div key={member} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                              <span className={`font-medium ${isPayer ? 'text-primaryColor-700' : 'text-gray-700'}`}>
                                {displayMember} {isPayer && '(ä»˜æ¬¾äºº)'}
                              </span>
                              {/* ä¿®æ­£ï¼šå¢åŠ  flex-shrink-0 ç¢ºä¿æŒ‰éˆ•ä¸æœƒåœ¨ Safari ä¸Šè¢«æ“ å£“æˆ–éš±è— */}
                              <div className="flex items-center space-x-2 flex-shrink-0">
                                <button
                                  onClick={() => handleShareChange(member, -1)}
                                  type="button"
                                  className="p-1.5 bg-red-50 text-red-600 rounded-lg transition hover:scale-105 transform hover:bg-red-100 shadow-sm border border-red-200 disabled:opacity-50 disabled:hover:scale-100"
                                  aria-label="æ¸›å°‘ä»½æ•¸"
                                  disabled={isReadOnly}
                                >
                                  <Minus className="w-5 h-5" />
                                </button>
                                <span className="w-8 text-center font-bold text-lg text-gray-800">{currentShares}</span>
                                <button
                                  onClick={() => handleShareChange(member, 1)}
                                  type="button"
                                  className="p-1.5 bg-green-50 text-green-600 rounded-lg transition hover:scale-105 transform hover:bg-green-100 shadow-sm border border-green-200 disabled:opacity-50 disabled:hover:scale-100"
                                  aria-label="å¢åŠ ä»½æ•¸"
                                  disabled={isReadOnly}
                                >
                                  <Plus className="w-5 h-5" />
                                </button>
                                <span className="text-sm text-gray-500 w-8 text-right">ä»½</span>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>

                  <div className="p-6 border-t flex justify-end">
                    <button
                      onClick={saveExpense}
                      disabled={isReadOnly || isLoadingModal || !newExpense.description.trim() || newExpense.originalAmount <= 0 || !newExpense.payerName}
                      className={`flex items-center px-6 py-3 rounded-full text-white font-semibold transition duration-150 shadow-md ${
                        (isReadOnly || isLoadingModal || !newExpense.description.trim() || newExpense.originalAmount <= 0 || !newExpense.payerName)
                          ? 'bg-gray-400 cursor-not-allowed'
                          : `bg-${primaryColor}-600 hover:bg-${primaryColor}-700 hover:shadow-lg`
                      }`}
                    >
                      {isLoadingModal ? 'å„²å­˜ä¸­...' : (
                        <>
                          <CircleCheck className="w-5 h-5 mr-2" />
                          {submitText}
                        </>
                      )}
                    </button>
                  </div>
                </div>
              </div>
            );
          });
          
          /**
           * æˆå“¡ç®¡ç† Modal (æ ¸å¿ƒé‚è¼¯ç¨ç«‹)
           */
          const MemberManagementModal = React.memo(({ db, currentUserId, members, customMembers, defaultSharesConfig, isMemberModalOpen, setIsMemberModalOpen, saveMembers, handleSaveDefaultShares, handleDeleteMember, setIsLoading, isLoading, setError, getDisplayName, isReadOnly, collectionId }) => {
            const [newMemberName, setNewMemberName] = useState(''); 
            const [tempDefaultShares, setTempDefaultShares] = useState({});

            useEffect(() => {
                if (isMemberModalOpen) {
                    const initialShares = members.reduce((acc, name) => {
                        const shareValue = defaultSharesConfig[name] !== undefined ? defaultSharesConfig[name] : 1;
                        acc[name] = shareValue;
                        return acc;
                    }, {});
                    setTempDefaultShares(initialShares);
                    setNewMemberName('');
                }
            }, [isMemberModalOpen, members, defaultSharesConfig]);
            
            const handleAddMemberInternal = async () => {
                if (isReadOnly) return setError('å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•æ–°å¢æˆå“¡ã€‚');
                
                const trimmedName = newMemberName.trim();
                if (trimmedName && trimmedName !== currentUserId && !customMembers.includes(trimmedName)) {
                    // ä¿®æ­£: å‘¼å« saveMembers æ™‚ï¼Œåªå‚³é customMembers (ä¸åŒ…å« currentUserId)
                    const newMemberList = [...customMembers, trimmedName];
                    await saveMembers(newMemberList); 
                    setNewMemberName('');
                } else if (trimmedName === currentUserId) {
                    setError("ä¸èƒ½å°‡è‡ªå·±çš„ç”¨æˆ¶ ID æ–°å¢ç‚ºæˆå“¡ã€‚");
                }
            };
            
            const handleTempShareChange = (name, delta) => {
                setTempDefaultShares(prev => {
                    const currentShares = prev[name] || 0;
                    const newShares = Math.max(0, currentShares + delta);
                    return {
                        ...prev,
                        [name]: newShares,
                    };
                });
            };
            
            const handleTempInputChange = (name, value) => {
                const shareCount = parseInt(value, 10);
                if (shareCount >= 0 || value === '') {
                    setTempDefaultShares(prev => ({
                        ...prev,
                        [name]: shareCount || 0
                    }));
                }
            };
            
            const handleMemberDeleteWrapper = async (member) => {
                if (isReadOnly) return setError('å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•åˆªé™¤æˆå“¡ã€‚');
                await handleDeleteMember(member);
            };

            
            if (!isMemberModalOpen) return null;


            return (
              <div className={`fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity`}>
                  <div className="bg-white rounded-xl w-full max-w-2xl shadow-2xl transform transition-transform duration-300 scale-100">
                      <div className="p-6 border-b flex justify-between items-center">
                          <h3 className="text-xl font-bold text-gray-800">ç®¡ç†åˆ†å¸³æˆå“¡èˆ‡é è¨­ä»½æ•¸ {isReadOnly && <span className="text-red-500 ml-2">(å”¯è®€)</span>}</h3>
                          <button onClick={() => setIsMemberModalOpen(false)} className="p-1 rounded-full hover:bg-gray-100 text-gray-600 transition hover:scale-110 transform">
                              <X className="w-6 h-6" />
                          </button>
                      </div>
                      
                      <div className="p-6 space-y-6">
                          {/* æ–°å¢æˆå“¡ */}
                          <div className="border p-4 rounded-lg bg-gray-50">
                              <h4 className="font-semibold text-lg mb-3 flex items-center text-primaryColor-700">
                                  <UserPlus className="w-5 h-5 mr-2" /> æ–°å¢æˆå“¡
                              </h4>
                              {/* ä¿®æ­£ 1: æ–°å¢æˆå“¡æŒ‰éˆ•ä½ˆå±€ä¿®æ­£ */}
                              <div className="flex gap-2 items-center"> 
                                  <input
                                      key="new-member-name" 
                                      type="text"
                                      value={newMemberName} 
                                      onChange={(e) => setNewMemberName(e.target.value)}
                                      onKeyDown={(e) => e.key === 'Enter' && handleAddMemberInternal()}
                                      placeholder="è¼¸å…¥æ–°æˆå“¡åç¨± (ä¾‹å¦‚: å°æ˜)"
                                      className="flex-grow border border-gray-300 rounded-lg p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500 disabled:bg-gray-100"
                                      disabled={isLoading || isReadOnly}
                                  />
                                  <button
                                      onClick={handleAddMemberInternal} 
                                      className={`flex-shrink-0 px-4 py-3 rounded-lg text-white font-semibold transition hover:scale-105 transform ${ // ç§»é™¤ w-20
                                          newMemberName.trim() === '' || isLoading || isReadOnly
                                          ? 'bg-gray-400 cursor-not-allowed'
                                          : `bg-${primaryColor}-600 hover:bg-${primaryColor}-700`
                                      }`}
                                      disabled={newMemberName.trim() === '' || isLoading || isReadOnly}
                                  >
                                      æ–°å¢
                                  </button>
                              </div>
                          </div>

                          {/* ç¾æœ‰æˆå“¡åˆ—è¡¨ */}
                          <div>
                              <h4 className="font-semibold text-lg mb-3 text-gray-700">è¨­å®šæ‰€æœ‰æˆå“¡çš„é è¨­ä»½æ•¸</h4>
                              <div className="grid grid-cols-2 gap-x-4 gap-y-2 mb-3 text-sm font-semibold text-gray-600 border-b pb-2">
                                <span>æˆå“¡åç¨±</span>
                                <span className="flex items-center justify-between">é è¨­ä»½æ•¸ (1ç‚ºå¹³å‡åˆ†é…)</span>
                              </div>
                              <div className="space-y-2 max-h-64 overflow-y-auto pr-2">
                                  {members.map(member => (
                                      <div key={member} className="grid grid-cols-[1fr_auto] gap-4 items-center p-3 rounded-lg border border-gray-200 bg-white shadow-sm">
                                          <span className={`font-medium ${member === currentUserId ? 'text-primaryColor-700' : 'text-gray-800'} truncate`} title={member}>
                                              {getDisplayName(member)}
                                          </span>
                                          <div className="flex items-center space-x-2 flex-shrink">
                                            
                                            <button
                                                onClick={() => handleTempShareChange(member, -1)}
                                                type="button"
                                                className="p-1.5 bg-red-50 text-red-600 rounded-lg transition hover:scale-105 transform hover:bg-red-100 shadow-sm border border-red-200 disabled:opacity-50"
                                                aria-label="æ¸›å°‘ä»½æ•¸"
                                                disabled={isReadOnly}
                                            >
                                                <Minus className="w-5 h-5" />
                                            </button>
                                            
                                            <input
                                                key={`shares-input-${member}`} 
                                                type="number"
                                                min="0"
                                                value={tempDefaultShares[member] === 0 ? 0 : tempDefaultShares[member] || 1}
                                                onChange={(e) => handleTempInputChange(member, e.target.value)}
                                                placeholder="1"
                                                className="w-16 border border-gray-300 rounded-lg p-2 text-center focus:ring-primaryColor-500 focus:border-primaryColor-500 disabled:bg-gray-100"
                                                disabled={isLoading || isReadOnly}
                                            />
                                            
                                            <button
                                                onClick={() => handleTempShareChange(member, 1)}
                                                type="button"
                                                className="p-1.5 bg-green-50 text-green-600 rounded-lg transition hover:scale-105 transform hover:bg-green-100 shadow-sm border border-green-200 disabled:opacity-50"
                                                aria-label="å¢åŠ ä»½æ•¸"
                                                disabled={isReadOnly}
                                            >
                                                <Plus className="w-5 h-5" />
                                            </button>
                                            
                                            <span className="text-gray-500">ä»½</span>
                                            {member !== currentUserId && (
                                                <button
                                                    onClick={() => handleMemberDeleteWrapper(member)}
                                                    className="p-1 text-red-500 hover:bg-red-100 rounded-full transition hover:scale-110 transform ml-auto disabled:opacity-50"
                                                    disabled={isLoading || isReadOnly}
                                                    aria-label="åˆªé™¤æˆå“¡"
                                                >
                                                    <UserMinus className="w-5 h-5" />
                                                </button>
                                            )}
                                          </div>
                                      </div>
                                  ))}
                              </div>
                          </div>
                      </div>
                      <div className="p-6 border-t flex justify-end">
                          <button
                              onClick={() => handleSaveDefaultShares(tempDefaultShares)}
                              disabled={isLoading || isReadOnly}
                              className={`flex items-center px-6 py-3 rounded-full text-white font-semibold transition hover:scale-105 transform duration-150 shadow-md ${
                                  isLoading || isReadOnly
                                  ? 'bg-gray-400 cursor-not-allowed'
                                  : `bg-${primaryColor}-600 hover:bg-${primaryColor}-700 hover:shadow-lg`
                              }`}
                          >
                              <CircleCheck className="w-5 h-5 mr-2" />
                              å„²å­˜é è¨­ä»½æ•¸
                          </button>
                      </div>
                  </div>
              </div>
            );
          });


        /**
         * ä¸»è¦çš„ App å…ƒä»¶
         */
        const App = () => {
          // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [userId, setUserId] = useState(null); // ç•¶å‰ç™»å…¥çš„ä½¿ç”¨è€… ID
          const [authReady, setAuthReady] = useState(false);
          const [userProfiles, setUserProfiles] = useState({});
		  const [lastExchangeUpdate, setLastExchangeUpdate] = useState(null);
          // æ–°å¢ç‹€æ…‹ï¼šç”¨æ–¼å„²å­˜å¯¦æ™‚åŒ¯ç‡
          const [liveExchangeRates, setLiveExchangeRates] = useState(DEFAULT_EXCHANGE_RATES);
          
          const [currentCollectionId, setCurrentCollectionId] = useState(null); // ç•¶å‰æ­£åœ¨æª¢è¦–çš„ç´€éŒ„ç°¿ ID (é è¨­ç‚º userId)
          const isReadOnly = userId !== currentCollectionId; // åˆ¤æ–·æ˜¯å¦ç‚ºå”¯è®€æ¨¡å¼

          const [expenses, setExpenses] = useState([]);
          const [customMembers, setCustomMembers] = useState([]); 
          const [defaultSharesConfig, setDefaultSharesConfig] = useState({}); 
          const [members, setMembers] = useState([]); 
          
          const [expenseModalState, setExpenseModalState] = useState({
              isOpen: false,
              editingExpense: null,
              isEditing: false,
          });
          
          // æ–°å¢ï¼šConfirmation Modal ç‹€æ…‹
          const [confirmModalState, setConfirmModalState] = useState({
              isOpen: false,
              title: '',
              message: '',
              confirmText: 'ç¢ºèª',
              confirmColor: 'red',
              onConfirm: () => {},
          });

          const [isMemberModalOpen, setIsMemberModalOpen] = useState(false);
          
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState(null);
          
          // --- 1. Firebase åˆå§‹åŒ–èˆ‡é©—è­‰ ---
          useEffect(() => {
            if (!firebaseConfig) {
              setError('Firebase configuration is missing.');
              setAuthReady(true); 
              return;
            }

            try {
              const app = firebase.initializeApp(firebaseConfig);
              const _auth = app.auth();
              const _db = app.firestore();

              setDb(_db);
              setAuth(_auth);

              // ç›£è½ Auth ç‹€æ…‹è®ŠåŒ–
              const unsubscribe = _auth.onAuthStateChanged((user) => {
                if (user) {
                    setUserId(user.uid);
                    
                    // ä¿®æ­£ 6: æª¢æŸ¥ URL åƒæ•¸ä»¥è™•ç†åˆ†äº«é€£çµ
                    const urlParams = new URLSearchParams(window.location.search);
                    const shareId = urlParams.get('shareId');

                    if (shareId && shareId.length === 28) {
                        setCurrentCollectionId(shareId);
                        // ç§»é™¤ URL åƒæ•¸ï¼Œé¿å…åˆ‡æ›ç´€éŒ„ç°¿æ™‚çš„è¡çª
                        history.replaceState(null, null, window.location.pathname);
                    } else {
                        // é¦–æ¬¡ç™»å…¥æˆ–ç‹€æ…‹ç¢ºèªå¾Œï¼Œå°‡ collectionId è¨­ç‚ºè‡ªå·±çš„ UID
                        setCurrentCollectionId(prev => prev || user.uid); 
                    }
                    
                } else {
                    setUserId(null);
                    setCurrentCollectionId(null);
                }
                setAuthReady(true);
              });
              
              return () => unsubscribe();
            } catch (e) {
              setError(`Firebase initialization failed: ${e.message}`);
              setAuthReady(true);
            }
          }, []);

          // --- 2. ç²å–æ‰€æœ‰å…¬å…±æš±ç¨± (Public User Profiles) ---
          useEffect(() => {
            if (!authReady || !db) return;
            
            // ä¿®æ­£ 4: ç›£è½å…¬å…±ç”¨æˆ¶æª”æ¡ˆé›†åˆ (3 æ®µè·¯å¾‘)
            // æ–°è·¯å¾‘: artifacts/{appId}/public_profiles
            const profilesCollectionPath = `artifacts/${appId}/public_profiles`;
            const profilesRef = db.collection(profilesCollectionPath);

            const unsubscribeProfiles = profilesRef.onSnapshot((snapshot) => {
                const profiles = {};
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    // ç¢ºä¿æˆ‘å€‘åªå„²å­˜ UID å’Œ displayName
                    if (data.uid && data.displayName) {
                        profiles[data.uid] = data.displayName;
                    }
                });
                setUserProfiles(profiles);
            }, (err) => {
                console.error("Error listening to user profiles:", err);
                // å¿½ç•¥æ¬Šé™éŒ¯èª¤ï¼Œå› ç‚ºå¦‚æœè¦å‰‡åªå…è¨±è®€å–ï¼Œè³‡æ–™å¯èƒ½å·²ç¶“è¢«è®€å–
            });

            return () => unsubscribeProfiles();
          }, [authReady, db]);

          // --- 3. ç²å–å¯¦æ™‚åŒ¯ç‡ ---
          useEffect(() => {
			fetchExchangeRates().then(result => {
				setLiveExchangeRates(result.rates);
				setLastExchangeUpdate(result.lastUpdate); // â¬… æ–°å¢é€™è¡Œ
			});
		  }, []);


          
          // ç™»å‡ºå‡½å¼
          const logout = useCallback(async () => {
            if (auth) {
                try {
                    await auth.signOut();
                    setExpenses([]);
                    setCustomMembers([]);
                    setDefaultSharesConfig({});
                } catch (e) {
                    setError(`ç™»å‡ºå¤±æ•—: ${e.message}`);
                }
            }
          }, [auth]);


          // --- 4. æ•¸æ“šç²å– (Firestore ç›£è½) ---
          useEffect(() => {
            // åªæœ‰ç•¶èªè­‰å®Œæˆä¸”æœ‰ Collection ID æ™‚æ‰é–‹å§‹ç›£è½
            if (!authReady || !db || !currentCollectionId) return; 

            // --- A. ç›£è½æ”¯å‡ºè¨˜éŒ„ ---
            const expensesCollectionPath = `artifacts/${appId}/users/${currentCollectionId}/expenses`;
            const expensesRef = db.collection(expensesCollectionPath);

            const unsubscribeExpenses = expensesRef.onSnapshot((snapshot) => {
              const fetchedExpenses = snapshot.docs.map(docSnap => {
                const data = docSnap.data();
                const timestamp = data.timestamp ? data.timestamp.toDate() : null; 
                
                // è™•ç†å¹£åˆ¥è½‰æ›æ¬„ä½çš„é è¨­å€¼
                const originalAmount = data.originalAmount !== undefined ? data.originalAmount : data.amount; // å…¼å®¹èˆŠè³‡æ–™
                const currency = data.currency || DEFAULT_CURRENCY;
                const exchangeRate = data.exchangeRate || (DEFAULT_EXCHANGE_RATES[currency] || 1.0); // ä½¿ç”¨é è¨­åŒ¯ç‡
                const amountInTWD = data.amountInTWD !== undefined ? data.amountInTWD : originalAmount * exchangeRate; // å…¼å®¹èˆŠè³‡æ–™

                return {
                  id: docSnap.id, 
                  ...data,
                  originalAmount: typeof originalAmount === 'number' ? originalAmount : parseFloat(originalAmount || 0),
                  currency: currency,
                  exchangeRate: exchangeRate,
                  amountInTWD: typeof amountInTWD === 'number' ? amountInTWD : parseFloat(amountInTWD || 0),
                  shares: data.shares || {},
                  timestamp: timestamp,
                };
              });
              setExpenses(fetchedExpenses);
            }, (err) => {
              console.error(`Error listening to expenses in collection ${currentCollectionId}:`, err);
              if (err.code === 'permission-denied') {
                  setError(`æ¬Šé™ä¸è¶³ï¼šç„¡æ³•è®€å– ID ç‚º ${currentCollectionId} çš„ç´€éŒ„ç°¿ã€‚è«‹ç¢ºèªæ‚¨æœ‰æ¬Šé™æˆ– ID æ­£ç¢ºã€‚`);
              } else {
                  setError(`è³‡æ–™åŒæ­¥å¤±æ•—: ${err.message}`);
              }
              setExpenses([]); // å¦‚æœæ¬Šé™ä¸è¶³ï¼Œæ¸…ç©ºç•¶å‰åˆ—è¡¨
            });

            // --- B. ç›£è½æˆå“¡è¨­å®š ---
            const membersDocPath = `artifacts/${appId}/users/${currentCollectionId}/settings/members`;
            const membersDocRef = db.doc(membersDocPath);

            const unsubscribeMembers = membersDocRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {Â 
                    const data = docSnap.data();
                    const list = Array.isArray(data.list) ? data.list : [];
                    const shares = data.defaultShares || {};
                    
                    setCustomMembers(list);
                    setDefaultSharesConfig(shares); 
                } else {
                    setCustomMembers([]);
                    setDefaultSharesConfig({}); 
                }
            }, (err) => {
                console.error("Error listening to members settings:", err);
            });

            return () => {
              unsubscribeExpenses();
              unsubscribeMembers();
            };
          }, [authReady, db, currentCollectionId]); // ä¾è³´ currentCollectionId

          // --- 5. è¡ç”Ÿç‹€æ…‹ï¼šè¨ˆç®—æœ€çµ‚æˆå“¡æ¸…å–® ---
          useEffect(() => {
            let currentMembers = [currentCollectionId].filter(Boolean); 
            
            customMembers.forEach(name => {
                if (name !== currentCollectionId && !currentMembers.includes(name)) {
                    currentMembers.push(name);
                }
            });

            setMembers(currentMembers.sort());

          }, [currentCollectionId, customMembers]);

          /**
           * æ ¹æ“šç•¶å‰çš„æˆå“¡æ¸…å–®å’Œé è¨­ä»½æ•¸é…ç½®ï¼Œç”¢ç”Ÿåˆå§‹çš„åˆ†å¸³ä»½æ•¸ç‰©ä»¶
           */
          const getInitialShares = useCallback(() => {
            return members.reduce((acc, name) => {
                const shareValue = defaultSharesConfig[name] !== undefined ? defaultSharesConfig[name] : 1;
                acc[name] = shareValue;
                return acc;
            }, {});
          }, [members, defaultSharesConfig]);


          // --- Modal é–‹å•Ÿ/é—œé–‰å’Œæ¨¡å¼æ§åˆ¶ ---
          const openConfirmModal = useCallback((title, message, onConfirm, confirmText = 'ç¢ºèª', confirmColor = 'red') => {
              setConfirmModalState({
                  isOpen: true,
                  title,
                  message,
                  confirmText,
                  confirmColor,
                  onConfirm,
              });
          }, []);

          const closeConfirmModal = useCallback(() => {
              setConfirmModalState(prev => ({ ...prev, isOpen: false }));
          }, []);


          const startAdd = useCallback(() => {
            if (isReadOnly) {
                setError('æ‚¨æ­£åœ¨ç€è¦½å…±äº«ç´€éŒ„ç°¿ï¼Œç„¡æ³•é€²è¡Œä¿®æ”¹ã€‚è«‹åˆ‡æ›å›æ‚¨çš„ç§æœ‰ç´€éŒ„ç°¿ã€‚');
                return;
            }
            setExpenseModalState({
                isOpen: true,
                editingExpense: null,
                isEditing: false,
            });
          }, [isReadOnly]);
          
          const startEdit = useCallback((expense) => {
             if (isReadOnly) {
                setError('æ‚¨æ­£åœ¨ç€è¦½å…±äº«ç´€éŒ„ç°¿ï¼Œç„¡æ³•é€²è¡Œä¿®æ”¹ã€‚è«‹åˆ‡æ›å›æ‚¨çš„ç§æœ‰ç´€éŒ„ç°¿ã€‚');
                return;
            }
            setExpenseModalState({
                isOpen: true,
                editingExpense: expense,
                isEditing: true,
            });
          }, [isReadOnly]);

          const closeExpenseModal = useCallback(() => {
            setExpenseModalState({
                isOpen: false,
                editingExpense: null,
                isEditing: false,
            });
            setError(null);
          }, []);


          // --- 6. æ”¯å‡º CRUD æ“ä½œ ---

          /**
           * åˆªé™¤æ”¯å‡ºè¨˜éŒ„
           */
          const deleteExpense = useCallback(async (id) => {
            if (isReadOnly) {
                setError('å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•åˆªé™¤ã€‚');
                return;
            }
            if (!db) return;

            const onConfirm = async () => {
                closeConfirmModal();
                setIsLoading(true);
                setError(null);
                try {
                    const docPath = `artifacts/${appId}/users/${currentCollectionId}/expenses/${id}`;
                    await db.doc(docPath).delete();
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    setError(`åˆªé™¤æ”¯å‡ºå¤±æ•—: ${e.message}`);
                } finally {
                    setIsLoading(false);
                }
            };
            
            openConfirmModal('ç¢ºèªåˆªé™¤æ”¯å‡º', 'æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚', onConfirm);
          }, [db, appId, currentCollectionId, isReadOnly, openConfirmModal, closeConfirmModal]);
          
          /**
           * æ¸…ç©ºæ‰€æœ‰æ”¯å‡ºè¨˜éŒ„
           */
          const clearAllExpenses = useCallback(async () => {
              if (isReadOnly) {
                  setError('å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•æ¸…é™¤è³‡æ–™ã€‚');
                  return;
              }
              if (!db) return;

              const onConfirm = async () => {
                  closeConfirmModal();
                  setIsLoading(true);
                  setError(null);
                  try {
                      const expensesCollectionPath = `artifacts/${appId}/users/${currentCollectionId}/expenses`;
                      const snapshot = await db.collection(expensesCollectionPath).get();

                      const batch = db.batch();
                      snapshot.docs.forEach(doc => {
                          batch.delete(doc.ref);
                      });
                      await batch.commit();
                      
                  } catch (e) {
                      console.error("Error clearing all documents: ", e);
                      setError(`æ¸…é™¤æ‰€æœ‰è³‡æ–™å¤±æ•—: ${e.message}`);
                  } finally {
                      setIsLoading(false);
                  }
              };

              openConfirmModal(
                  'ç¢ºèªæ¸…é™¤æ‰€æœ‰æ”¯å‡º', 
                  'æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜å¸³ç°¿ä¸­çš„æ‰€æœ‰æ”¯å‡ºè¨˜éŒ„å—ï¼Ÿï¼ˆæˆå“¡æ¸…å–®å’Œé è¨­ä»½æ•¸å°‡è¢«ä¿ç•™ï¼‰', 
                  onConfirm
              );
          }, [db, appId, currentCollectionId, isReadOnly, openConfirmModal, closeConfirmModal]);


          // --- 7. æˆå“¡ç®¡ç†é‚è¼¯ ---
          
          /**
           * å„²å­˜æˆå“¡æ¸…å–®å’Œç•¶å‰çš„é è¨­ä»½æ•¸è¨­å®š
           */
          const saveMembers = useCallback(async (newMemberList) => {
            if (isReadOnly) return;
            if (!db) return;

            setIsLoading(true);
            setError(null);
            try {
                const docPath = `artifacts/${appId}/users/${currentCollectionId}/settings/members`;
                const membersDocRef = db.doc(docPath);

                const sanitizedList = Array.from(new Set(
                    newMemberList.filter(name => name.trim() !== '' && name !== currentCollectionId)
                ));

                const currentShares = {};
                members.forEach(name => {
                    const share = defaultSharesConfig[name] !== undefined ? defaultSharesConfig[name] : 1;
                    if (share !== 1 && share >= 0) {
                        currentShares[name] = share;
                    }
                });

                await membersDocRef.set({ list: sanitizedList, defaultShares: currentShares }, { merge: false });
            } catch (e) {
                console.error("Error saving members:", e);
                setError(`å„²å­˜æˆå“¡æ¸…å–®å¤±æ•—: ${e.message}`);
            } finally {
                setIsLoading(false);
            }
          }, [db, appId, currentCollectionId, isReadOnly, members, defaultSharesConfig]);
          
          const handleDeleteMember = useCallback(async (nameToDelete) => {
            if (isReadOnly) return;
            
            const onConfirm = async () => {
                closeConfirmModal();
                const newMemberList = customMembers.filter(name => name !== nameToDelete);
                await saveMembers(newMemberList);
            };

            openConfirmModal(
                'ç¢ºèªåˆªé™¤æˆå“¡', 
                `æ‚¨ç¢ºå®šè¦å¾æˆå“¡æ¸…å–®ä¸­ç§»é™¤ ${getDisplayName(nameToDelete)} å—ï¼Ÿ`, 
                onConfirm
            );

          }, [customMembers, saveMembers, isReadOnly, openConfirmModal, closeConfirmModal, getDisplayName]);
          
          /**
           * å„²å­˜é è¨­ä»½æ•¸è¨­å®š
           */
          const handleSaveDefaultShares = useCallback(async (tempShares) => {
            if (isReadOnly) return;
            if (!db) return;

            setIsLoading(true);
            setError(null);
            try {
                const docPath = `artifacts/${appId}/users/${currentCollectionId}/settings/members`;
                const membersDocRef = db.doc(docPath);

                const sharesToSave = {};
                members.forEach(name => {
                    const share = tempShares[name]; 
                    if (share !== undefined && share >= 0) {
                        if (share !== 1) { 
                            sharesToSave[name] = share;
                        }
                    }
                });
                
                await membersDocRef.set({ list: customMembers, defaultShares: sharesToSave }, { merge: false });
                
                setIsMemberModalOpen(false);
            } catch (e) {
                console.error("Error saving default shares:", e);
                setError(`å„²å­˜é è¨­ä»½æ•¸å¤±æ•—: ${e.message}`);
            } finally {
                setIsLoading(false);
            }
          }, [db, appId, currentCollectionId, customMembers, members, isReadOnly]);


          // --- 8. æ¸…ç®—çµé¤˜åŠŸèƒ½ (æ–°å¢) ---
          
          /**
           * çµç®—å–®ä¸€æˆå“¡çš„æ¬ æ¬¾
           * @param {string} debtorId - æ¬ æ¬¾äºº/å‚µå‹™äºº ID
           * @param {number} amount - æ¬ æ¬¾é‡‘é¡ (æ­£æ•¸)
           * @param {string} creditorId - æ”¶æ¬¾äºº/å‚µæ¬Šäºº ID
           */
          const settleMemberDebt = useCallback(async (debtorId, amount, creditorId) => {
              if (isReadOnly) {
                  setError('å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•é€²è¡Œçµç®—æ“ä½œã€‚');
                  return;
              }
              if (!db || !userId) return;

              const roundedAmount = Math.round(amount);
              if (roundedAmount <= 0) return;

              const onConfirm = async () => {
                  closeConfirmModal();
                  setIsLoading(true);
                  setError(null);
                  try {
                      // å»ºç«‹ä¸€ç­†æ”¯å‡ºè¨˜éŒ„ä¾†å¹³è¡¡å¸³ç›®
                      const collectionPath = `artifacts/${appId}/users/${currentCollectionId}/expenses`;
                      
                      // ç”±æ–¼æ¸…ç®—é …ç›®æ˜¯ debtorId -> creditorIdï¼Œæˆ‘å€‘è¨˜éŒ„çš„æ”¯å‡ºæ˜¯ debtorId ä»˜çµ¦ creditorId çš„éŒ¢
                      await db.collection(collectionPath).add({
                          description: `[çµæ¸…] ${getDisplayName(debtorId)} æ­¸é‚„çµ¦ ${getDisplayName(creditorId)} æ¬ æ¬¾`,
                          amount: roundedAmount,
                          payerName: debtorId, // æ¬ æ¬¾äººæ”¯ä»˜ (æ¬¾é …ä¾†æº)
                          shares: { [creditorId]: roundedAmount }, // æ”¶æ¬¾äººæ‰¿æ“”é€™ç­†è²»ç”¨ï¼Œä½¿å¾—ä»–çš„æ·¨é¤˜é¡å¢åŠ 
                          timestamp: serverTimestamp(),
                          creatorId: userId,
                          appId: appId,
                      });
                      
                  } catch (e) {
                      console.error("Error settling debt: ", e);
                      setError(`çµç®—å¤±æ•—: ${e.message}`);
                  } finally {
                      setIsLoading(false);
                  }
              };
              
              openConfirmModal(
                  'ç¢ºèªè½‰å¸³çµæ¸…', 
                  `æ‚¨ç¢ºå®š ${getDisplayName(debtorId)} å·²å‘ ${getDisplayName(creditorId)} æ”¯ä»˜ TWD ${roundedAmount.toFixed(0)} ä¸¦çµæ¸…æ¬ æ¬¾å—ï¼Ÿ`, 
                  onConfirm, 
                  'ç¢ºèªçµæ¸…', 
                  'green'
              );

          }, [db, userId, currentCollectionId, isReadOnly, getDisplayName, openConfirmModal, closeConfirmModal]);


          // --- 9. åˆ†å¸³è¨ˆç®—é‚è¼¯ (èˆ‡ä¹‹å‰ç›¸åŒ) ---

          /**
           * è¨ˆç®—æ¯å€‹æˆå“¡çš„æœ€çµ‚é¤˜é¡ï¼ˆæ‡‰ä»˜/æ‡‰æ”¶ï¼‰
           */
          const calculateBalances = useMemo(() => {
            const balances = members.reduce((acc, name) => ({ ...acc, [name]: 0 }), {});

            expenses.forEach(expense => {
              // ä¿®æ­£: ç¢ºä¿ä½¿ç”¨ amountInTWD é€²è¡Œè¨ˆç®—
              const amount = expense.amountInTWD; 
              const { payerName, shares } = expense;
              const totalShares = Object.values(shares).reduce((sum, s) => sum + s, 0);

              if (totalShares === 0) return;

              const costPerShare = amount / totalShares;

              if (balances[payerName] !== undefined) {
                balances[payerName] += amount;
              }

              Object.entries(shares).forEach(([member, shareCount]) => {
                const memberCost = costPerShare * shareCount;
                if (balances[member] !== undefined) {
                  balances[member] -= memberCost;
                }
              });
            });

            return balances;
          }, [expenses, members]);

          /**
           * è¨ˆç®—æ¸…ç®—æ–¹æ¡ˆï¼šæœ€å°‘æ¬¡æ•¸çš„è½‰å¸³ä¾†çµæ¸…æ‰€æœ‰å‚µå‹™
           */
          const calculateSettlements = useMemo(() => {
            const balances = calculateBalances;
            const settlements = [];

            const creditors = []; 
            const debtors = []; 

            const mutableBalances = { ...balances };

            for (const member in mutableBalances) {
                const balance = mutableBalances[member];
                if (balance >= 1) { 
                    creditors.push({ name: member, amount: balance });
                } else if (balance <= -1) { 
                    debtors.push({ name: member, amount: -balance }); 
                }
            }

            let i = 0; 
            let j = 0; 

            while (i < debtors.length && j < creditors.length) {
                const debtor = debtors[i];
                const creditor = creditors[j];

                const transferAmount = Math.round(Math.min(debtor.amount, creditor.amount));

                if (transferAmount > 0) {
                    settlements.push({
                        from: debtor.name,
                        to: creditor.name,
                        amount: transferAmount,
                    });
                }

                debtor.amount -= transferAmount;
                creditor.amount -= transferAmount;

                if (debtor.amount < 1) { 
                    i++;
                }
                if (creditor.amount < 1) {
                    j++;
                }
            }
            
            return settlements;
          }, [calculateBalances]); 

          // --- 10. UI è¼”åŠ©å…ƒä»¶ ---

          // ç²å–é¡¯ç¤ºåç¨±ï¼ˆä½¿ç”¨å…¬å…±æš±ç¨±/Auth Profile/UIDï¼‰
          const getDisplayName = useCallback((memberId) => {
            
            // 1. å„ªå…ˆå¾å…¬å…± profiles æŸ¥æ‰¾æš±ç¨±
            if (userProfiles[memberId]) {
                return userProfiles[memberId];
            }
            
            // 2. ç•¶å‰ç™»å…¥è€… (ä½¿ç”¨ Auth Profile æš±ç¨±æˆ– Email)
            if (memberId === userId) {
                const currentUser = auth.currentUser;
                // å‚™ç”¨æ–¹æ¡ˆ: å¦‚æœæ²’æœ‰æš±ç¨±ï¼Œé¡¯ç¤º Email
                return currentUser?.displayName || currentUser?.email || 'æˆ‘ (You)';
            }
            
            // 3. ç´€éŒ„ç°¿æ“æœ‰è€… (å…±äº«æ¨¡å¼ä¸‹çš„å‚™ç”¨é¡¯ç¤º)
            if (memberId === currentCollectionId) {
                // å¦‚æœæ‰¾ä¸åˆ°æš±ç¨±ï¼Œå‰‡é¡¯ç¤º UID çš„ç°¡çŸ­å½¢å¼
                const shortId = memberId.substring(0, 5) + '...' + memberId.substring(memberId.length - 5);
                return `${shortId}`; // ç§»é™¤ (æ“æœ‰è€…)ï¼Œè®“ CollectionSwitch è² è²¬æ·»åŠ æ¨™è¨˜
            }
            
            // 4. å…¶ä»–æˆå“¡ (è‡ªè¨‚åç¨±æˆ–æ‰¾ä¸åˆ°çš„ UID)
            return memberId;
          }, [userId, auth, currentCollectionId, userProfiles]);
          
          // æ ¼å¼åŒ–æ™‚é–“æˆ³
          const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'ç„¡æ—¥æœŸ';
            const date = timestamp instanceof Date ? timestamp : (timestamp.toDate ? timestamp.toDate() : null);
            if (!date) return 'ç„¡æ—¥æœŸ';

            return date.toLocaleDateString('zh-TW', {
              year: 'numeric',
              month: 'numeric',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            });
          };

          // --- æ¸²æŸ“é‚è¼¯ ---
          
          if (!authReady) {
            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                    <p className={`text-lg text-${primaryColor}-600`}>è¼‰å…¥é©—è­‰æœå‹™...</p>
                </div>
            );
          }
          
          if (!userId || !auth) {
            // ä¿®æ­£ï¼šå‚³é db å¯¦ä¾‹çµ¦ AuthModal ä»¥é€²è¡Œæš±ç¨±å„²å­˜
            return <AuthModal auth={auth} db={db} />;
          }


          return (
            <div className="min-h-screen bg-gray-50 p-4 sm:p-8">
              <div className="max-w-4xl mx-auto">
                {/* æ¨™é¡Œå’Œä¸»è¦æ“ä½œæŒ‰éˆ• */}
                <header className="py-6 border-b border-gray-200">
                  <h1 className={`text-4xl font-extrabold text-${primaryColor}-700 flex items-center`}>
                    <Pencil className="w-10 h-10 mr-3" />
                    åˆ†å¸³è¨˜å¸³ç°¿
                  </h1>
                  <p className="text-gray-500 mt-1">
                    ç•¶å‰ä½¿ç”¨è€…: <span className="font-semibold text-gray-700">{getDisplayName(userId)}</span>
                  </p>
				  {lastExchangeUpdate && (
					<p className="text-xs text-gray-500 mt-1">
					  åŒ¯ç‡æœ€å¾Œæ›´æ–°ï¼š{new Date(lastExchangeUpdate).toLocaleString('zh-TW')}
					</p>
				  )}
                </header>
                
                {/* éŒ¯èª¤è¨Šæ¯æç¤º */}
                {error && (
                    <div className="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                        <p className="font-semibold">éŒ¯èª¤æç¤º:</p>
                        <p className="text-sm">{error}</p>
                    </div>
                )}

                {/* ç´€éŒ„ç°¿åˆ‡æ›/å…±äº«è³‡è¨Š */}
                <CollectionSwitch 
                    userId={userId} 
                    currentCollectionId={currentCollectionId} 
                    setCurrentCollectionId={setCurrentCollectionId} 
                    getDisplayName={getDisplayName}
                    logout={logout}
                    userProfiles={userProfiles} // å‚³é userProfiles
                />

                {/* ä¸»è¦åŠŸèƒ½å€å¡Š */}
                <div className="mt-6 flex space-x-4">
                  <button
                    onClick={startAdd}
                    disabled={isReadOnly}
                    className={`flex-1 flex items-center justify-center px-4 py-3 rounded-xl text-white transition duration-300 shadow-xl hover:scale-[1.03] transform disabled:bg-gray-400 disabled:cursor-not-allowed ${
                        isReadOnly ? 'bg-gray-400' : `bg-${primaryColor}-500 hover:bg-${primaryColor}-600 focus:ring-4 focus:ring-${primaryColor}-300`
                    }`}
                  >
                    <Plus className="w-6 h-6 mr-2" />
                    æ–°å¢æ”¯å‡º {isReadOnly && '(å”¯è®€)'}
                  </button>
                  <button
                    onClick={() => { setIsMemberModalOpen(true); setError(null); }}
                    disabled={isReadOnly}
                    className={`px-4 py-3 border text-lg font-bold rounded-xl bg-white focus:outline-none focus:ring-4 focus:ring-${primaryColor}-300 transition duration-300 shadow-xl hover:scale-[1.03] transform disabled:border-gray-400 disabled:text-gray-400 disabled:cursor-not-allowed ${
                        isReadOnly ? 'border-gray-400 text-gray-400' : `border-${primaryColor}-500 text-${primaryColor}-600 hover:bg-${primaryColor}-50`
                    }`}
                    aria-label="ç®¡ç†æˆå“¡èˆ‡é è¨­ä»½æ•¸"
                  >
                    <Users className="w-6 h-6" />
                  </button>
                </div>

                {/* ç¸½çµèˆ‡åˆ—è¡¨ */}
                <BalanceSummary 
                    settlements={calculateSettlements} 
                    balances={calculateBalances} 
                    members={members} 
                    getDisplayName={getDisplayName} 
                    isReadOnly={isReadOnly}
                    settleMemberDebt={settleMemberDebt} // å‚³éçµæ¸…åŠŸèƒ½
                    currentCollectionId={currentCollectionId}
                />
                <ExpenseList 
                    expenses={expenses} 
                    deleteExpense={deleteExpense} 
                    startEdit={startEdit} 
                    isLoading={isLoading} 
                    getDisplayName={getDisplayName} 
                    formatTimestamp={formatTimestamp}
                    isReadOnly={isReadOnly}
                    clearAllExpenses={clearAllExpenses} // å‚³éæ¸…ç©ºåŠŸèƒ½
                />

                {/* Modal å€å¡Š */}
                <ExpenseModal 
                    key={expenseModalState.isEditing ? `edit-${expenseModalState.editingExpense.id}` : 'add-new'}
                    db={db}
                    currentUserId={userId}
                    members={members}
                    getInitialShares={getInitialShares}
                    state={expenseModalState}
                    onClose={closeExpenseModal}
                    getDisplayName={getDisplayName} 
                    isReadOnly={isReadOnly}
                    collectionId={currentCollectionId}
                    liveExchangeRates={liveExchangeRates}
                />
                <MemberManagementModal 
                    db={db}
                    currentUserId={userId}
                    members={members}
                    customMembers={customMembers}
                    defaultSharesConfig={defaultSharesConfig}
                    isMemberModalOpen={isMemberModalOpen}
                    setIsMemberModalOpen={setIsMemberModalOpen}
                    saveMembers={saveMembers}
                    handleSaveDefaultShares={handleSaveDefaultShares}
                    handleDeleteMember={handleDeleteMember}
                    setIsLoading={setIsLoading}
                    isLoading={isLoading}
                    setError={setError}
                    getDisplayName={getDisplayName}
                    isReadOnly={isReadOnly}
                    collectionId={currentCollectionId}
                />
                
                {/* çµ±ä¸€çš„ç¢ºèªæç¤º Modal */}
                <ConfirmationModal 
                    isOpen={confirmModalState.isOpen}
                    onClose={closeConfirmModal}
                    onConfirm={confirmModalState.onConfirm}
                    title={confirmModalState.title}
                    message={confirmModalState.message}
                    confirmText={confirmModalState.confirmText}
                    confirmColor={confirmModalState.confirmColor}
                />
              </div>

              {/* Tailwind color class fix, ensuring primaryColor is rendered */}
              <div className={`text-${primaryColor}-500 bg-${primaryColor}-500 border-${primaryColor}-500 hidden`}></div>
            </div>
          );
        };
        
        // --- ç¨ç«‹çš„åˆ—è¡¨å’Œç¸½çµçµ„ä»¶ (å¾ App ç§»å‡º) ---
        
        const ExpenseList = React.memo(({ expenses, deleteExpense, startEdit, isLoading, getDisplayName, formatTimestamp, isReadOnly, clearAllExpenses }) => {
            const sortedExpenses = useMemo(() => {
                return [...expenses].sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.getTime() : 0;
                    const timeB = b.timestamp ? b.timestamp.getTime() : 0;
                    return timeB - timeA; // é™åº (æ–°åˆ°èˆŠ)
                });
            }, [expenses]);
              
            return (
              <div className="mt-8">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                    <CircleDollarSign className="w-7 h-7 mr-3 text-primaryColor-500" /> 
                    æ‰€æœ‰æ”¯å‡º ({sortedExpenses.length})
                  </h2>
                  <button
                      onClick={clearAllExpenses}
                      disabled={isLoading || isReadOnly || sortedExpenses.length === 0}
                      className="px-3 py-1.5 text-sm rounded-lg text-white bg-red-500 hover:bg-red-600 transition hover:scale-105 transform shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center"
                  >
                      <Trash2 className="w-4 h-4 mr-1" />
                      æ¸…é™¤æ‰€æœ‰è³‡æ–™
                  </button>
                </div>
                
                {sortedExpenses.length === 0 ? (
                  <p className="text-gray-500 italic p-4 bg-white rounded-xl shadow-inner">ç›®å‰æ²’æœ‰ä»»ä½•æ”¯å‡ºè¨˜éŒ„ã€‚</p>
                ) : (
                  <div className="space-y-4">
                    {sortedExpenses.map((exp) => {
                      const totalShares = Object.values(exp.shares).reduce((sum, s) => sum + s, 0);
                      const sharesDetail = Object.entries(exp.shares)
                        .filter(([, share]) => share > 0)
                        .map(([name, share]) => `${getDisplayName(name)} (${share}ä»½)`)
                        .join(', ')

                      // ä¿®æ­£: é¡¯ç¤ºåŸå§‹å¹£åˆ¥å’Œæ›ç®—é‡‘é¡
                      const displayAmount = `${exp.currency} ${Math.round(exp.originalAmount).toFixed(0)}`;
                      const convertedTWD = exp.currency !== DEFAULT_CURRENCY ? ` (TWD ${exp.amountInTWD.toFixed(0)})` : '';

                      return (
                        <div key={exp.id} className="bg-white p-4 rounded-xl shadow-lg border-l-4 border-primaryColor-400 flex justify-between items-center transition duration-150 hover:shadow-xl">
                          <div className="flex-grow">
                            <p className="font-semibold text-lg text-gray-800">{exp.description}</p>
                            {/* é¡¯ç¤ºåŸå§‹å¹£åˆ¥å’Œ TWD æ›ç®— */}
                            <p className="text-3xl font-extrabold text-primaryColor-600 my-1">
                                {displayAmount}
                                <span className="text-xl font-normal text-gray-500">{convertedTWD}</span>
                            </p> 
                            <p className="text-sm text-gray-600">
                              <span className="font-medium text-primaryColor-700">ä»˜æ¬¾äºº:</span> {getDisplayName(exp.payerName)}
                            </p>
                            <p className="text-xs text-gray-500 mt-1">
                              <span className="font-medium">åˆ†å¸³:</span> {sharesDetail || 'ç„¡äººåˆ†å¸³'} (ç¸½ä»½æ•¸: {totalShares})
                            </p>
                            <p className="text-xs text-gray-400 mt-1">
                              <span className="font-medium">æ™‚é–“:</span> {formatTimestamp(exp.timestamp)}
                            </p>
                          </div>
                          {/* å”¯è®€æ¨¡å¼ä¸‹ç¦ç”¨ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ• */}
                          <div className={`flex space-x-2 ${isReadOnly ? 'opacity-50' : ''}`}>
                            <button
                              onClick={() => startEdit(exp)}
                              className="p-2 text-blue-500 bg-white hover:bg-blue-50 rounded-full transition duration-150 hover:scale-110 transform border border-transparent hover:border-blue-300 shadow-md disabled:cursor-not-allowed"
                              aria-label="ç·¨è¼¯æ”¯å‡º"
                              disabled={isReadOnly}
                            >
                              <Pencil className="w-5 h-5" />
                            </button>
                            <button
                              onClick={() => deleteExpense(exp.id)}
                              disabled={isLoading || isReadOnly}
                              className="p-2 text-red-500 bg-white hover:bg-blue-50 rounded-full transition duration-150 hover:scale-110 transform border border-transparent hover:border-red-300 shadow-md disabled:cursor-not-allowed"
                              aria-label="åˆªé™¤æ”¯å‡º"
                            >
                              <Trash2 className="w-5 h-5" />
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            );
          });

          const BalanceSummary = React.memo(({ settlements, balances, members, getDisplayName, isReadOnly, settleMemberDebt, currentCollectionId }) => {
            const debtorBalances = useMemo(() => {
                return members.filter(member => Math.round(balances[member] || 0) < 0)
                               .map(member => ({
                                   id: member,
                                   amount: Math.abs(Math.round(balances[member] || 0)),
                                   displayName: getDisplayName(member),
                               }))
                               .filter(d => d.amount > 0);
            }, [balances, members, getDisplayName]);

            return (
              <div className="mt-8 p-6 bg-white rounded-xl shadow-2xl">
                <h2 className="text-2xl font-bold mb-4 text-gray-800 flex items-center">
                  <Users className="w-7 h-7 mr-3 text-primaryColor-500" />
                  çµé¤˜ç¸½çµ 
                </h2>

                {settlements.length === 0 ? (
                    <p className="text-lg font-medium text-green-600 p-3 bg-green-50 rounded-lg">ğŸ‰ æ‰€æœ‰å¸³ç›®å·²çµæ¸…ï¼</p>
                ) : (
                    <div className="space-y-4">
                        <p className="text-base text-gray-600 mb-4">çµæ¸…å¸³ç›®æ‰€éœ€çš„è½‰å¸³æ¸…å–®ï¼ˆå››æ¨äº”å…¥ï¼‰ï¼š</p>
                        {settlements.map((settlement, index) => {
                            // åˆ¤æ–·æŒ‰éˆ•é¡å‹
                            // ä¿®æ­£: ç´€éŒ„ç°¿æ“æœ‰è€…å¯ä»¥ä»£ç‚ºç¢ºèªæ‰€æœ‰è½‰å¸³
                            const canSettle = !isReadOnly; 

                            return (
                                <div 
                                    key={index} 
                                    <div className="bg-yellow-50 p-4 rounded-xl shadow-md border-l-4 border-yellow-400 flex justify-between items-stretch transition duration-150">
                                >
                                    <div className="flex items-center">
                                        <span className="font-bold text-yellow-800 text-xl mr-3">ğŸ’¸</span>
                                        <div className="text-gray-800">
                                            <p className="text-lg">
                                                <span className="font-bold text-red-600">{getDisplayName(settlement.from)}</span>
                                                <span className="mx-1 text-gray-500">æ‡‰ä»˜çµ¦</span>
                                                <span className="font-bold text-green-600">{getDisplayName(settlement.to)}</span>
                                            </p>
                                            <p className="text-3xl font-extrabold text-yellow-700 mt-1">
                                                TWD {settlement.amount.toFixed(0)}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    {/* ä¿®æ­£: ç´€éŒ„ç°¿æ“æœ‰è€…å¯ä»¥ä»£ç‚ºçµæ¸…æ‰€æœ‰è½‰å¸³ */}
                                    {canSettle && (
                                        <button
                                            onClick={() => settleMemberDebt(settlement.from, settlement.amount, settlement.to)} 
                                            className={`self-end mt-2 px-3 py-1 text-sm rounded-lg text-white transition hover:scale-105 transform shadow-md flex items-center bg-green-500 hover:bg-green-600`}
                                        >
                                            <CircleCheck className="w-4 h-4 mr-1" />
                                            çµæ¸…
                                        </button>
                                    )}
                                    {/* å”¯è®€æ¨¡å¼ä¸‹é¡¯ç¤ºç‹€æ…‹ (å¯é¸) */}
                                    {isReadOnly && (
                                         <span className="text-sm text-gray-500 italic">åƒ…æ“æœ‰è€…å¯æ“ä½œ</span>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                )}
                
                {/* ç§»é™¤äº†å€‹äººç¸½çµé¤˜ (åƒè€ƒ) */}
                
              </div>
            );
          });
        
        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>